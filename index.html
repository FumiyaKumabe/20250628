<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管制Proクラウド(仮称)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: flex-end;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .side-menu-overlay.open {
            visibility: visible;
            opacity: 1;
        }
        .side-menu-content {
            background-color: white;
            width: 100%;
            max-width: 320px;
            height: 100%;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            padding: 24px;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .side-menu-overlay.open .side-menu-content {
            transform: translateX(0);
        }
        .side-menu-close-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #6b7280;
        }
        .side-menu-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #1f2937;
        }
        .side-menu-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            font-size: 1.125rem;
            color: #374151;
        }
        .side-menu-item:last-child {
            border-bottom: none;
        }
        .side-menu-item:hover {
            background-color: #f3f4f6;
            border-radius: 4px;
        }

        .modal-overlay { /* Generic modal overlay */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1010; /* Base Z-index for modals */
            visibility: hidden;
            opacity: 0;
            transition: visibility 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .modal-overlay.open {
            visibility: visible;
            opacity: 1;
        }
        .modal-content { /* Generic modal content */
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            max-width: 95%;
            width: 500px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .modal-close-button { /* Generic modal close button */
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        .modal-title { /* Generic modal title */
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            text-align: center;
            margin-bottom: 1rem;
        }

        /* Specific modal Z-indices */
        #calendar-modal { z-index: 1020; }
        #phone-call-modal { z-index: 1030; }
        #account-settings-modal { z-index: 1040; }
        #individual-account-settings-modal { z-index: 1050; }
        #assignment-detail-modal { z-index: 1025; /* Between calendar and phone call */ }


        .sort-indicator {
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid #9ca3af;
            margin-left: 4px;
            vertical-align: middle;
            transition: transform 0.2s ease-in-out;
            opacity: 0;
        }
        .sort-indicator.active {
            opacity: 1;
        }
        .sort-indicator.asc {
            transform: rotate(0deg);
        }
        .sort-indicator.desc {
            transform: rotate(180deg);
        }

        .status-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }

        .status-tag-completed {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-tag-pending {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-tag-in-progress {
            background-color: #d1fae5;
            color: #065f46;
        }

        .text-xxs {
            font-size: 0.625rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }
        .device-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
            font-size: 0.95rem;
            color: #4b5563;
        }
        .device-list-item:last-child {
            border-bottom: none;
        }
        .device-action-button {
            background-color: #ef4444;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .device-action-button:hover {
            background-color: #dc2626;
        }
        .add-device-button {
            background-color: #22c55e;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-top: 1rem;
        }
        .add-device-button:hover {
            background-color: #16a34a;
        }

        .assignment-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .assignment-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .assignment-card-detail {
            font-size: 0.95rem;
            color: #4b5563;
        }
        .assignment-card-counts {
            display: flex;
            justify-content: space-around;
            gap: 0.75rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }
        .assignment-card-count-item {
            flex: 1;
            min-width: 100px;
            text-align: center;
            background-color: #f3f4f6;
            padding: 0.5rem 0.25rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            position: relative;
        }
        .assignment-card-count-item:hover {
            background-color: #e5e7eb;
            transform: translateY(-2px);
        }
        .assignment-card-count-label {
            font-size: 0.75rem;
            color: #6b7280;
            display: block;
            margin-bottom: 0.25rem;
        }
        .assignment-card-count-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: #3b82f6;
        }
        .assignment-card-count-number.zero-count {
            color: #9ca3af;
        }

        .tooltip {
            position: absolute;
            background-color: #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
            z-index: 1060;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            pointer-events: none;
            transform: translateX(-50%);
            left: 50%;
            top: calc(100% + 10px);
            bottom: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .tooltip.visible {
            opacity: 1;
            visibility: visible;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            left: 50%;
            top: -5px;
            bottom: auto;
            transform: translateX(-50%) rotate(45deg);
            width: 10px;
            height: 10px;
            background-color: #333;
            z-index: -1;
        }
        .tooltip-content {
            text-align: left;
            max-height: 150px;
            overflow-y: auto;
        }
        .tooltip-content ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .tooltip-content li {
            padding: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tooltip-content li:last-child {
            border-bottom: none;
        }

        .consecutive-work-red {
            color: #dc2626;
            font-weight: bold;
        }

        /* Styles for the new assignment detail modal */
        .assignment-detail-modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            max-width: 95%;
            width: 450px; /* Adjusted width for detail modal */
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 16px;
            text-align: center;
        }

        .assignment-detail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px; /* Increased padding */
            border: 1px solid #d1d5db; /* Slightly darker border */
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .assignment-detail-item:hover {
            background-color: #e5e7eb; /* Lighter hover background */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); /* More prominent shadow on hover */
        }

        .assignment-detail-label {
            font-size: 0.95rem; /* Slightly larger font */
            color: #4b5563; /* Darker gray for better contrast */
            font-weight: 500;
        }

        .assignment-detail-value {
            font-size: 1.15rem; /* Slightly larger font */
            font-weight: 600;
            color: #1f2937; /* Darker text for values */
            word-break: break-word; /* Ensure long addresses wrap */
            text-decoration: none; /* Remove underline by default */
        }

        /* Removed link-style as per user request for assignment name, 
            but keeping it here in case it's needed for other links in the future. */
        /* .assignment-detail-value.link-style {
            color: #3b82f6;
            text-decoration: underline;
        } */

        /* Calendar specific styles */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            text-align: center;
            margin-top: 16px;
        }
        .calendar-grid .day-label {
            font-weight: bold;
            color: #4b5563;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
            display: flex; /* Ensure day labels are centered */
            align-items: center;
            justify-content: center;
        }
        .calendar-grid span.current-month {
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            background-color: #f9fafb;
            color: #1f2937;
            display: flex; /* Use flex to center the number */
            align-items: center;
            justify-content: center;
            height: 40px; /* Give a fixed height for consistent grid cells */
        }
        .calendar-grid span.current-month:hover {
            background-color: #e5e7eb;
        }
        .calendar-grid span.sunday {
            color: #ef4444; /* Red for Sunday */
        }
        .calendar-grid span.saturday {
            color: #3b82f6; /* Blue for Saturday */
        }
        .calendar-grid span.today {
            background-color: #bfdbfe; /* Light blue for today */
            font-weight: bold;
            color: #1e40af;
            border: 1px solid #60a5fa;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex items-start justify-center">

    <div id="main-app-content" class="w-full max-w-screen-xl">
        <div class="flex flex-wrap items-center justify-between bg-white p-3 md:p-4 rounded-xl shadow-md mb-6 gap-3">
            <div class="flex items-center flex-wrap gap-2">
                <button id="prev-day-button" class="flex items-center justify-center p-1 bg-transparent text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors w-6 h-6 md:w-7 md:h-7 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left">
                        <path d="m15 18-6-6 6-6"/>
                    </svg>
                </button>
                <div class="text-lg md:text-xl font-semibold text-gray-800 whitespace-nowrap">
                    <span id="system-date"></span>
                </div>
                <button id="next-day-button" class="flex items-center justify-center p-1 bg-transparent text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors w-6 h-6 md:w-7 md:h-7 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right">
                        <path d="m9 18 6-6-6-6"/>
                    </svg>
                </button>
                <button id="calendar-button" class="flex items-center justify-center p-1 bg-transparent text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors w-9 h-9 md:w-10 md:h-10 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar">
                        <path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/>
                    </svg>
                </button>
            </div>

            <div class="flex items-center flex-wrap gap-2 md:gap-3">
                <button id="unassigned-personnel-button" title="未配置者確認画面" class="flex items-center justify-center p-2 bg-transparent text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors w-9 h-9 md:w-10 md:h-10 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user text-gray-700">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                    </svg>
                </button>
                <button id="screen-switch-button" title="配置先別サマリー" class="flex items-center justify-center p-2 bg-transparent text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors w-9 h-9 md:w-10 md:h-10 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-grid">
                        <rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/>
                    </svg>
                </button>
                <select id="status-search-select" class="p-2 rounded-md border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 w-48 text-gray-700">
                    <option value="">全てのステータス</option>
                    <option value="報告待ち">報告待ち</option>
                    <option value="上番待ち">上番待ち</option>
                    <option value="上番完了">上番完了</option>
                    <option value="下番待ち">下番待ち</option>
                    <option value="下番完了">下番完了</option>
                    <option value="勤務中">勤務中</option>
                </select>
                <!-- Moved main-search-input here -->
                <input type="text" id="main-search-input" placeholder="隊員名、得意先、配置先で検索..." class="p-2 rounded-md border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 w-48 text-gray-700">
                <button id="notification-button" class="relative flex items-center justify-center p-2 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 transition-colors w-9 h-9 md:w-10 md:h-10 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-bell">
                        <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
                    </svg>
                    <span id="notification-badge" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full transform translate-x-1/2 -translate-y-1/2">
                    </span>
                </button>
                <button id="options-button" class="flex items-center justify-center p-2 bg-gray-300 text-gray-800 rounded-full shadow-md hover:bg-gray-400 transition-colors w-9 h-9 md:w-10 md:h-10 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-more-horizontal">
                        <circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/>
                    </svg>
                </button>
            </div>
        </div>

        <div id="table-container" class="bg-white p-4 rounded-xl shadow-md overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="no">
                            <div class="flex items-center justify-center">
                                <span>NO</span>
                                <span class="sort-indicator"></span>
                            </div>
                        </th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap min-w-40 cursor-pointer" data-sort-key="teamMember">
                            <div class="flex items-center justify-center">
                                <span>隊員名</span>
                                <span class="sort-indicator"></span>
                            </div>
                        </th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="branch">
                            <div class="flex items-center justify-center">
                                <span>支店</span>
                                <span class="sort-indicator"></span>
                            </div>
                        </th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="client">
                            <div class="flex items-center justify-center">
                                <span>得意先</span>
                                <span class="sort-indicator"></span>
                            </div>
                        </th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="assignment">
                            <div class="flex items-center justify-center">
                                <span>配置先</span>
                                <span class="sort-indicator"></span>
                            </div>
                        </th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="workContent">
                            <div class="flex items-center justify-center">
                                <span>業務内容</span>
                                <span class="sort-indicator"></span>
                            </div>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">基本時間</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">報告時間</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="status">
                            <div class="flex items-center justify-center">
                                <span>ステータス</span>
                                <span class="sort-indicator"></span>
                            </div>
                        </th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="remarks">
                            <div class="flex items-center justify-center">
                                <span>備考</span>
                                <span class="sort-indicator"></span>
                            </div>
                        </th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="receptionTime">
                            <div class="flex items-center justify-center">
                                <span>受信時間</span>
                                <span class="sort-indicator"></span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                </tbody>
            </table>
        </div>
    </div>

    <div id="switched-screen-content" class="w-full max-w-screen-xl hidden">
        <div class="bg-white p-4 rounded-xl shadow-md relative">
            <button id="summary-close-button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center mt-8">配置先別サマリー</h2>

            <div class="flex flex-wrap items-center justify-between bg-white p-3 md:p-4 rounded-xl shadow-md mb-6 gap-3">
                <div class="flex items-center flex-wrap gap-2">
                    <button id="summary-prev-day-button" class="flex items-center justify-center p-1 bg-transparent text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors w-6 h-6 md:w-7 md:h-7 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left">
                            <path d="m15 18-6-6 6-6"/>
                        </svg>
                    </button>
                    <div class="text-lg md:text-xl font-semibold text-gray-800 whitespace-nowrap">
                        <span id="summary-system-date"></span>
                    </div>
                    <button id="summary-next-day-button" class="flex items-center justify-center p-1 bg-transparent text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors w-6 h-6 md:w-7 md:h-7 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right">
                            <path d="m9 18 6-6-6-6"/>
                        </svg>
                    </button>
                    <button id="summary-calendar-button" class="flex items-center justify-center p-1 bg-transparent text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors w-9 h-9 md:w-10 md:h-10 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar">
                            <path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/>
                        </svg>
                    </button>
                </div>

                <div class="flex flex-wrap items-center justify-end gap-4">
                    <div class="flex flex-wrap gap-2" id="summary-branch-checkboxes-container">
                    </div>

                    <button id="summary-pending-filter" class="px-4 py-2 bg-yellow-500 text-white rounded-md shadow-md hover:bg-yellow-600 transition-colors">
                        報告待ちのみ表示
                    </button>
                </div>
            </div>

            <div id="assignment-summary-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            </div>
            <div class="flex justify-center mt-6">
                <button id="back-to-main-button" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 transition-colors">メイン画面に戻る</button>
            </div>
        </div>
    </div>

    <div id="unassigned-personnel-screen" class="w-full max-w-screen-xl hidden">
        <div class="bg-white p-4 rounded-xl shadow-md relative">
            <button id="unassigned-close-button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center mt-8">未配置者確認画面</h2>

            <div class="flex flex-wrap items-center justify-between bg-white p-3 md:p-4 rounded-xl shadow-md mb-6 gap-3">
                <div class="flex items-center flex-wrap gap-2">
                    <button id="unassigned-prev-day-button" class="flex items-center justify-center p-1 bg-transparent text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors w-6 h-6 md:w-7 md:h-7 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left">
                            <path d="m15 18-6-6 6-6"/>
                        </svg>
                    </button>
                    <div class="text-lg md:text-xl font-semibold text-gray-800 whitespace-nowrap">
                        <span id="unassigned-system-date"></span>
                    </div>
                    <button id="unassigned-next-day-button" class="flex items-center justify-center p-1 bg-transparent text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors w-6 h-6 md:w-7 md:h-7 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right">
                            <path d="m9 18 6-6-6-6"/>
                        </svg>
                    </button>
                    <button id="unassigned-calendar-button" class="flex items-center justify-center p-1 bg-transparent text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors w-9 h-9 md:w-10 md:h-10 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar">
                            <path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/>
                        </svg>
                    </button>
                </div>

                <div class="flex flex-wrap items-center justify-end gap-4">
                    <div class="flex flex-wrap gap-2" id="unassigned-branch-checkboxes-container">
                    </div>
                    <input type="text" id="unassigned-search-input" placeholder="隊員名、状況で検索..." class="p-2 rounded-md border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 w-48 text-gray-700">
                </div>
            </div>

            <div class="overflow-x-auto border border-gray-200 rounded-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="branch">
                                <div class="flex items-center">
                                    <span>支店</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="teamMember">
                                <div class="flex items-center">
                                    <span>隊員名</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="consecutiveWorkStatus">
                                <div class="flex items-center">
                                    <span>連勤状況</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="holidayStatus">
                                <div class="flex items-center">
                                    <span>休日状況</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="unassigned-personnel-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div class="flex justify-center mt-6">
                <button id="unassigned-back-to-main-button" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 transition-colors">メイン画面に戻る</button>
            </div>
        </div>
    </div>

    <div id="work-history-screen" class="w-full max-w-screen-xl hidden">
        <div class="bg-white p-4 rounded-xl shadow-md relative">
            <button id="work-history-close-button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            <h2 id="work-history-title" class="text-2xl font-bold text-gray-800 mb-4 text-center mt-8">勤務履歴確認画面</h2>

            <div class="flex flex-wrap items-center justify-between bg-white p-3 md:p-4 rounded-xl shadow-md mb-6 gap-3">
                <div class="flex items-center flex-wrap gap-2">
                    <button id="work-history-prev-day-button" class="flex items-center justify-center p-1 bg-transparent text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors w-6 h-6 md:w-7 md:h-7 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left">
                            <path d="m15 18-6-6 6-6"/>
                        </svg>
                    </button>
                    <div class="text-lg md:text-xl font-semibold text-gray-800 whitespace-nowrap">
                        <span id="work-history-system-date"></span>
                    </div>
                    <button id="work-history-next-day-button" class="flex items-center justify-center p-1 bg-transparent text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors w-6 h-6 md:w-7 md:h-7 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right">
                            <path d="m9 18 6-6-6-6"/>
                        </svg>
                    </button>
                    <button id="work-history-calendar-button" class="flex items-center justify-center p-1 bg-transparent text-gray-700 hover:bg-gray-200 hover:text-gray-900 transition-colors w-9 h-9 md:w-10 md:h-10 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar">
                            <path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/>
                        </svg>
                    </button>
                </div>

                <div class="flex flex-wrap items-center justify-end gap-4">
                    <div class="flex flex-wrap gap-2" id="work-history-branch-checkboxes-container">
                    </div>
                    <input type="text" id="work-history-search-input" placeholder="隊員名、状況で検索..." class="p-2 rounded-md border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 w-48 text-gray-700">
                    <button id="work-history-unassigned-filter" class="px-4 py-2 bg-yellow-500 text-white rounded-md shadow-md hover:bg-yellow-600 transition-colors">
                        未配置者のみ表示
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto border border-gray-200 rounded-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="branch">
                                <div class="flex items-center">
                                    <span>支店</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="teamMember">
                                <div class="flex items-center">
                                    <span>隊員名</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="consecutiveWorkStatus">
                                <div class="flex items-center">
                                    <span>連勤状況</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="holidayStatus">
                                <div class="flex items-center">
                                    <span>休日状況</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="assignmentStatus">
                                <div class="flex items-center">
                                    <span>配置状況</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer" data-sort-key="lastWorkDate">
                                <div class="flex items-center">
                                    <span>最終勤務日</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="work-history-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div class="flex justify-center mt-6">
                <button id="work-history-back-to-main-button" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 transition-colors">メイン画面に戻る</button>
            </div>
        </div>
    </div>


    <div id="detail-tooltip" class="tooltip">
        <div class="tooltip-content"></div>
    </div>

    <div id="side-menu-container" class="side-menu-overlay">
        <div class="side-menu-content rounded-l-xl">
            <button id="side-menu-close-button" class="side-menu-close-button">&times;</button>
            <h3 id="dynamic-side-menu-title" class="side-menu-title"></h3>
            <div id="side-menu-content-area" class="space-y-3 text-left overflow-y-auto flex-grow">
            </div>
        </div>
    </div>

    <div id="line-notification-settings-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="line-notification-modal-close-button" class="modal-close-button">&times;</button>
            <h3 class="modal-title">LINE通知設定</h3>

            <div class="space-y-4">
                <h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-2">通知設定</h4>
                <div class="flex items-center space-x-2">
                    <label for="departure-time" class="text-gray-700 whitespace-nowrap">自宅出発：勤務開始の</label>
                    <input type="number" id="departure-time" value="60" class="w-20 p-2 border border-gray-300 rounded-md text-center">
                    <span class="text-gray-700">分前</span>
                </div>
                <div class="flex items-center space-x-2">
                    <label for="start-report-time" class="text-gray-700 whitespace-nowrap">上番報告：勤務開始の</label>
                    <input type="number" id="start-report-time" value="10" class="w-20 p-2 border border-gray-300 rounded-md text-center">
                    <span class="text-gray-700">分前</span>
                </div>
                <div class="flex items-center space-x-2">
                    <label for="end-report-time" class="text-gray-700 whitespace-nowrap">下番報告：勤務終了の</label>
                    <input type="number" id="end-report-time" value="10" class="w-20 p-2 border border-gray-300 rounded-md text-center">
                    <span class="text-gray-700">分後</span>
                </div>
            </div>

            <div class="overflow-x-auto border border-gray-200 rounded-md mt-6">
                <h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-2 px-4 pt-2">隊員情報</h4>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                <span class="text-gray-400 text-xxs font-normal block">NO</span>
                                <span>支店</span>
                            </th>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                <span class="text-gray-400 text-xxs font-normal block">NO</span>
                                <span>隊員名</span>
                            </th>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">LINE ID</th>
                        </tr>
                    </thead>
                    <tbody id="line-member-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>

            <div class="flex justify-end space-x-4 mt-6">
                <button id="save-line-settings" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 transition-colors">保存</button>
                <button id="cancel-line-settings" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md shadow-md hover:bg-gray-400 transition-colors">取消</button>
            </div>
        </div>
    </div>

    <div id="calendar-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="calendar-modal-close-button" class="modal-close-button">&times;</button>
            <div class="calendar-header">
                <button id="prev-month-button" class="p-1 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left">
                        <path d="m15 18-6-6 6-6"/>
                    </svg>
                </button>
                <span id="calendar-month-year"></span>
                <button id="next-month-button" class="p-1 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right">
                        <path d="m9 18 6-6-6-6"/>
                    </svg>
                </button>
            </div>
            <div class="calendar-grid" id="calendar-grid">
                <span class="day-label">日</span>
                <span class="day-label">月</span>
                <span class="day-label">火</span>
                <span class="day-label">水</span>
                <span class="day-label">木</span>
                <span class="day-label">金</span>
                <span class="day-label">土</span>
            </div>
        </div>
    </div>

    <div id="phone-call-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="phone-call-modal-close-button" class="modal-close-button">&times;</button>
            <h3 id="phone-call-modal-title" class="modal-title"></h3>
            <p id="phone-call-modal-number" class="text-2xl font-bold text-gray-900 mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="call-button" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 transition-colors">電話をかける</button>
                <button id="cancel-call-button" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md shadow-md hover:bg-gray-400 transition-colors">取消</button>
            </div>
        </div>
    </div>

    <div id="account-settings-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="account-settings-modal-close-button" class="modal-close-button">&times;</button>
            <h3 class="modal-title">アカウント設定</h3>
            <div id="account-list-area" class="flex-grow overflow-y-auto space-y-2">
            </div>
            <button id="add-account-button" class="mt-4 px-6 py-2 bg-green-500 text-white rounded-md shadow-md hover:bg-green-600 transition-colors">アカウント追加</button>
        </div>
    </div>

    <div id="individual-account-settings-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="individual-account-settings-modal-close-button" class="modal-close-button">&times;</button>
            <h3 id="individual-account-settings-title" class="modal-title"></h3>

            <div>
                <h4 class="section-title">通知設定</h4>
                <div class="flex items-center space-x-2">
                    <label for="individual-departure-time" class="text-gray-700 whitespace-nowrap">自宅出発：勤務開始の</label>
                    <input type="number" id="individual-departure-time" value="60" class="w-20 p-2 border border-gray-300 rounded-md text-center">
                    <span class="text-gray-700">分前</span>
                </div>
                <div class="flex items-center space-x-2">
                    <label for="individual-start-report-time" class="text-gray-700 whitespace-nowrap">上番報告：勤務開始の</label>
                    <input type="number" id="individual-start-report-time" value="10" class="w-20 p-2 border border-gray-300 rounded-md text-center">
                    <span class="text-gray-700">分前</span>
                </div>
                <div class="flex items-center space-x-2">
                    <label for="individual-end-report-time" class="text-gray-700 whitespace-nowrap">下番報告：勤務終了の</label>
                    <input type="number" id="individual-end-report-time" value="10" class="w-20 p-2 border border-gray-300 rounded-md text-center">
                    <span class="text-gray-700">分後</span>
                </div>

                <div class="mt-4">
                    <h5 class="text-base font-semibold text-gray-800 mb-2">通知支店</h5>
                    <div id="notification-branches-checkboxes" class="grid grid-cols-2 gap-2 text-gray-700">
                    </div>
                </div>
            </div>

            <div>
                <h4 class="section-title">通知端末の設定/追加</h4>
                <div id="notification-device-list" class="space-y-2">
                </div>
                <button id="add-notification-device-button" class="add-device-button">通知端末追加</button>
            </div>

            <div>
                <h4 class="section-title">勤怠表示支店</h4>
                <div id="attendance-display-branches-checkboxes" class="grid grid-cols-2 gap-2 text-gray-700">
                </div>
            </div>

            <div>
                <h4 class="section-title">パスワードの変更</h4>
                <button id="change-password-button" class="w-full px-6 py-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 transition-colors">パスワードを変更</button>
            </div>

            <div>
                <h4 class="section-title">アカウントの削除</h4>
                <button id="delete-account-button" class="w-full px-6 py-2 bg-red-500 text-white rounded-md shadow-md hover:bg-red-600 transition-colors">アカウントを削除</button>
            </div>

            <div class="flex justify-end space-x-4 mt-6">
                <button id="save-individual-account-settings" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 transition-colors">保存</button>
                <button id="cancel-individual-account-settings" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md shadow-md hover:bg-gray-400 transition-colors">取消</button>
            </div>
        </div>
    </div>

    <!-- New Assignment Detail Modal -->
    <div id="assignment-detail-modal" class="modal-overlay">
        <div class="assignment-detail-modal-content">
            <button id="assignment-detail-modal-close-button" class="modal-close-button">&times;</button>
            <h3 id="assignment-detail-modal-title" class="modal-title"></h3>
            
            <div class="grid grid-cols-1 gap-4">
                <div id="assignment-detail-work-history" class="assignment-detail-item">
                    <span class="assignment-detail-label">勤務履歴</span>
                    <span class="assignment-detail-value">確認する</span>
                </div>
                <div id="assignment-detail-phone-number" class="assignment-detail-item">
                    <span class="assignment-detail-label">電話番号</span>
                    <span class="assignment-detail-value"></span>
                </div>
                <div id="assignment-detail-site-address" class="assignment-detail-item">
                    <span class="assignment-detail-label">現場住所</span>
                    <span class="assignment-detail-value"></span>
                </div>
                <!-- New: Site Supervisor Name -->
                <div id="assignment-detail-site-supervisor" class="assignment-detail-item">
                    <span class="assignment-detail-label">現場監督名</span>
                    <span class="assignment-detail-value"></span>
                </div>
            </div>

            <div class="flex justify-end mt-4">
                <button id="assignment-detail-ok-button" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 transition-colors">OK</button>
            </div>
        </div>
    </div>


    <script>
        let currentSystemDate = new Date();
        let currentCalendarDate = new Date(); // Initialize for calendar modal

        document.addEventListener('DOMContentLoaded', () => {
            const mainDateElement = document.getElementById('system-date');
            const mainPrevDayButton = document.getElementById('prev-day-button');
            const mainNextDayButton = document.getElementById('next-day-button');
            const mainCalendarButton = document.getElementById('calendar-button');
            const mainSearchInput = document.getElementById('main-search-input'); // New search input

            const summaryDateElement = document.getElementById('summary-system-date');
            const summaryPrevDayButton = document.getElementById('summary-prev-day-button');
            const summaryNextDayButton = document.getElementById('summary-next-day-button');
            const summaryCalendarButton = document.getElementById('summary-calendar-button');

            const unassignedDateElement = document.getElementById('unassigned-system-date');
            const unassignedPrevDayButton = document.getElementById('unassigned-prev-day-button');
            const unassignedNextDayButton = document.getElementById('unassigned-next-day-button');
            const unassignedCalendarButton = document.getElementById('unassigned-calendar-button');

            const workHistoryDateElement = document.getElementById('work-history-system-date');
            const workHistoryPrevDayButton = document.getElementById('work-history-prev-day-button');
            const workHistoryNextDayButton = document.getElementById('work-history-next-day-button');
            const workHistoryCalendarButton = document.getElementById('work-history-calendar-button');


            function updateDateDisplay(date, dateElementId, dayOfWeekSpanId) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dayOfWeek = date.getDay();
                const daysOfWeekJapanese = ['日', '月', '火', '水', '木', '金', '土'];
                const dayOfWeekAbbreviation = daysOfWeekJapanese[dayOfWeek];

                const dateStringWithoutDay = `${year}/${month}/${day} (`;
                
                const targetElement = document.getElementById(dateElementId);
                if (targetElement) {
                    targetElement.innerHTML = `${dateStringWithoutDay}<span id="${dayOfWeekSpanId}">${dayOfWeekAbbreviation}</span>)`;
                    const dayOfWeekSpan = document.getElementById(dayOfWeekSpanId);
                    if (dayOfWeekSpan) {
                        dayOfWeekSpan.classList.remove('text-red-600', 'text-blue-700');
                        if (dayOfWeek === 0) { dayOfWeekSpan.classList.add('text-red-600'); } else if (dayOfWeek === 6) { dayOfWeekSpan.classList.add('text-blue-700'); }
                    }
                }
            }

            function updateAllDateDisplays() {
                updateDateDisplay(currentSystemDate, 'system-date', 'day-of-week-span');
                updateDateDisplay(currentSystemDate, 'summary-system-date', 'summary-day-of-week-span');
                updateDateDisplay(currentSystemDate, 'unassigned-system-date', 'unassigned-day-of-week-span');
                updateDateDisplay(currentSystemDate, 'work-history-system-date', 'work-history-day-of-week-span');
            }

            updateAllDateDisplays();

            const notificationButton = document.getElementById('notification-button');
            const notificationBadge = document.getElementById('notification-badge');
            const optionsButton = document.getElementById('options-button');
            const sideMenuContainer = document.getElementById('side-menu-container');
            const dynamicSideMenuTitle = document.getElementById('dynamic-side-menu-title');
            const sideMenuContentArea = document.getElementById('side-menu-content-area');
            const sideMenuCloseButton = document.getElementById('side-menu-close-button');
            const tableBody = document.getElementById('table-body');

            const statusSearchSelect = document.getElementById('status-search-select');

            const calendarModal = document.getElementById('calendar-modal');
            const calendarModalCloseButton = document.getElementById('calendar-modal-close-button');
            const calendarMonthYear = document.getElementById('calendar-month-year');
            const calendarGrid = document.getElementById('calendar-grid');
            const prevMonthButton = document.getElementById('prev-month-button');
            const nextMonthButton = document.getElementById('next-month-button');

            const lineNotificationSettingsModal = document.getElementById('line-notification-settings-modal');
            const lineNotificationModalCloseButton = document.getElementById('line-notification-modal-close-button');
            const saveLineSettingsButton = document.getElementById('save-line-settings');
            const cancelLineSettingsButton = document.getElementById('cancel-line-settings');

            const phoneCallModal = document.getElementById('phone-call-modal');
            const phoneCallModalCloseButton = document.getElementById('phone-call-modal-close-button');
            const phoneCallModalTitle = document.getElementById('phone-call-modal-title');
            const phoneCallModalNumber = document.getElementById('phone-call-modal-number');
            const callButton = document.getElementById('call-button');
            const cancelCallButton = document.getElementById('cancel-call-button');

            const accountSettingsModal = document.getElementById('account-settings-modal');
            const accountSettingsModalCloseButton = document.getElementById('account-settings-modal-close-button');
            const accountListArea = document.getElementById('account-list-area');
            const addAccountButton = document.getElementById('add-account-button');

            const individualAccountSettingsModal = document.getElementById('individual-account-settings-modal');
            const individualAccountSettingsModalCloseButton = document.getElementById('individual-account-settings-modal-close-button');
            const individualAccountSettingsTitle = document.getElementById('individual-account-settings-title');
            const individualDepartureTime = document.getElementById('individual-departure-time');
            const individualStartReportTime = document.getElementById('individual-start-report-time');
            const individualEndReportTime = document.getElementById('individual-end-report-time');
            const notificationDeviceList = document.getElementById('notification-device-list');
            const addNotificationDeviceButton = document.getElementById('add-notification-device-button');
            const changePasswordButton = document.getElementById('change-password-button');
            const deleteAccountButton = document.getElementById('delete-account-button');
            const saveIndividualAccountSettingsButton = document.getElementById('save-individual-account-settings');
            const cancelIndividualAccountSettingsButton = document.getElementById('cancel-individual-account-settings');

            const notificationBranchesCheckboxes = document.getElementById('notification-branches-checkboxes');
            const attendanceDisplayBranchesCheckboxes = document.getElementById('attendance-display-branches-checkboxes');

            const mainAppContent = document.getElementById('main-app-content');
            const switchedScreenContent = document.getElementById('switched-screen-content');
            const unassignedPersonnelScreen = document.getElementById('unassigned-personnel-screen');
            const workHistoryScreen = document.getElementById('work-history-screen');
            const workHistoryTableBody = document.getElementById('work-history-table-body');
            const workHistoryCloseButton = document.getElementById('work-history-close-button');
            const workHistoryBackToMainButton = document.getElementById('work-history-back-to-main-button');
            const workHistoryTitle = document.getElementById('work-history-title');
            const workHistoryBranchCheckboxesContainer = document.getElementById('work-history-branch-checkboxes-container');
            const workHistorySearchInput = document.getElementById('work-history-search-input');
            const workHistoryUnassignedFilterButton = document.getElementById('work-history-unassigned-filter');


            const unassignedPersonnelButton = document.getElementById('unassigned-personnel-button');
            const unassignedPersonnelTableBody = document.getElementById('unassigned-personnel-table-body');
            const unassignedCloseButton = document.getElementById('unassigned-close-button');
            const unassignedBackToMainButton = document.getElementById('unassigned-back-to-main-button');
            const unassignedBranchCheckboxesContainer = document.getElementById('unassigned-branch-checkboxes-container');
            const unassignedSearchInput = document.getElementById('unassigned-search-input');

            const screenSwitchButton = document.getElementById('screen-switch-button');
            const backToMainButton = document.getElementById('back-to-main-button');
            const assignmentSummaryContainer = document.getElementById('assignment-summary-container');
            const summaryCloseButton = document.getElementById('summary-close-button');

            const summaryBranchCheckboxesContainer = document.getElementById('summary-branch-checkboxes-container');
            const summaryPendingFilter = document.getElementById('summary-pending-filter');

            const detailTooltip = document.getElementById('detail-tooltip');
            const tooltipContent = detailTooltip.querySelector('.tooltip-content');

            // New Assignment Detail Modal elements
            const assignmentDetailModal = document.getElementById('assignment-detail-modal');
            const assignmentDetailModalCloseButton = document.getElementById('assignment-detail-modal-close-button');
            const assignmentDetailModalTitle = document.getElementById('assignment-detail-modal-title');
            const assignmentDetailWorkHistory = document.getElementById('assignment-detail-work-history');
            const assignmentDetailPhoneNumber = document.getElementById('assignment-detail-phone-number');
            const assignmentDetailSiteAddress = document.getElementById('assignment-detail-site-address');
            const assignmentDetailSiteSupervisor = document.getElementById('assignment-detail-site-supervisor'); // New element
            const assignmentDetailOkButton = document.getElementById('assignment-detail-ok-button');


            let allTableData = [
                {
                    no: 1, teamMember: '隈部 文哉', branch: '福岡支店', client: 'ビジコン建設', assignment: '博多駅筑紫口前工事',
                    workContent: '日勤', baseTime: '08:00～17:00', reportTime: '08:00～17:00', status: '下番完了',
                    remarks: '', receptionTime: '17:15', phoneNumber: '09012345678', lineId: 'fumiya.kumabe',
                    lastWorkDate: '2025/06/27',
                    assignmentStatus: '配置済み',
                    consecutiveWorkStatus: '3連勤中',
                    holidayStatus: '',
                    siteAddress: '福岡県福岡市博多区博多駅中央街1-1',
                    siteSupervisor: '田中 健太郎' // Added site supervisor
                },
                {
                    no: 4, teamMember: '山田 太郎', branch: '東京支店', client: '中央開発', assignment: '新宿駅東口再開発',
                    workContent: '夜勤', baseTime: '22:00～07:00', reportTime: '', status: '報告待ち',
                    remarks: '', receptionTime: '', phoneNumber: '08098765432', lineId: 'taro.yamada',
                    lastWorkDate: '2025/06/28',
                    assignmentStatus: '配置済み',
                    consecutiveWorkStatus: '3連勤中',
                    holidayStatus: '',
                    siteAddress: '東京都新宿区新宿3丁目38-1',
                    siteSupervisor: '鈴木 一郎' // Added site supervisor
                },
                {
                    no: 5, teamMember: '佐藤 花子', branch: '大阪支店', client: '関西電鉄', assignment: '梅田地下街警備',
                    workContent: '日勤', baseTime: '14:00～22:00', reportTime: '14:00～22:00', status: '下番完了',
                    remarks: '', receptionTime: '22:04', phoneNumber: '07011223344', lineId: 'hanako.sato',
                    lastWorkDate: '2025/06/27',
                    assignmentStatus: '配置済み',
                    consecutiveWorkStatus: '3連勤中',
                    holidayStatus: '',
                    siteAddress: '大阪府大阪市北区梅田1丁目',
                    siteSupervisor: '山本 太郎' // Added site supervisor
                },
                {
                    no: 6, teamMember: '高橋 悟', branch: '東京支店', client: '中央開発', assignment: '新宿駅東口再開発',
                    workContent: '夜勤', baseTime: '22:00～07:00', reportTime: '22:00～', status: '勤務中',
                    remarks: '', receptionTime: '', phoneNumber: '08012345670', lineId: 'satoru.takahashi',
                    lastWorkDate: '2025/06/28',
                    assignmentStatus: '配置済み',
                    consecutiveWorkStatus: '3連勤中',
                    holidayStatus: '',
                    siteAddress: '東京都新宿区新宿3丁目38-1',
                    siteSupervisor: '鈴木 一郎' // Added site supervisor
                },
                {
                    no: 7, teamMember: '中村 健一', branch: '大阪支店', client: '関西電鉄', assignment: '梅田地下街警備',
                    workContent: '日勤', baseTime: '14:00～22:00', reportTime: '14:00～22:00', status: '下番完了',
                    remarks: '', receptionTime: '22:05', phoneNumber: '07055554444', lineId: 'kenichi.nakamura',
                    lastWorkDate: '2025/06/27',
                    assignmentStatus: '配置済み',
                    consecutiveWorkStatus: '3連勤中',
                    holidayStatus: '',
                    siteAddress: '大阪府大阪市北区梅田1丁目',
                    siteSupervisor: '山本 太郎' // Added site supervisor
                }
            ];

            const originalEntryNo1 = allTableData.find(item => item.no === 1);
            if (originalEntryNo1) {
                const newEntry1 = { ...originalEntryNo1, no: 2, teamMember: '田中 健太', lineId: 'kenta.tanaka', status: '下番完了', lastWorkDate: '2025/06/26', assignmentStatus: '配置済み', consecutiveWorkStatus: '3連勤中', holidayStatus: '', siteSupervisor: '佐藤 次郎' }; // Added site supervisor
                const newEntry2 = { ...originalEntryNo1, no: 3, teamMember: '鈴木 美咲', lineId: 'misaki.suzuki', status: '下番完了', lastWorkDate: '2025/06/25', assignmentStatus: '配置済み', consecutiveWorkStatus: '3連勤中', holidayStatus: '', siteSupervisor: '高橋 吾郎' }; // Added site supervisor
                allTableData.push(newEntry1, newEntry2);
            }

            const allBranches = [...new Set(allTableData.map(item => item.branch))].sort();

            let newUnassignedEntries = [];
            let nextNo = allTableData.length + 1;
            const unassignedNames = [
                '加藤 陽子', '林 拓也', '後藤 舞', '佐々木 亮', '松本 麗奈',
                '井上 大輔', '斎藤 裕美', '木村 健太', '小林 沙織', '吉田 隼人',
                '渡辺 健二', '伊藤 明美', '山本 浩司', '中野 恵子', '小川 隆'
            ];
            const unassignedConsecutiveStatuses = ['2連勤中', '3連勤中', '4連勤中', '5連勤中', '6連勤中'];
            const unassignedHolidayStatuses = [''];

            const uniqueAssignments = [...new Set(allTableData.map(item => item.assignment))];

            for (let i = 0; i < 10; i++) {
                const randomBranch = allBranches[Math.floor(Math.random() * allBranches.length)];
                const randomAssignment = uniqueAssignments[Math.floor(Math.random() * uniqueAssignments.length)];
                const randomConsecutiveStatus = unassignedConsecutiveStatuses[Math.floor(Math.random() * unassignedConsecutiveStatuses.length)];
                
                let holidayStatus = '';
                if (unassignedNames[i % unassignedNames.length] === '松本 麗奈' ||
                    unassignedNames[i % unassignedNames.length] === '後藤 舞' ||
                    unassignedNames[i % unassignedNames.length] === '木村 健太') {
                    holidayStatus = '休日';
                }

                newUnassignedEntries.push({
                    no: nextNo++,
                    teamMember: unassignedNames[i % unassignedNames.length],
                    branch: randomBranch,
                    client: '未配置先',
                    assignment: randomAssignment,
                    workContent: '未定',
                    baseTime: '未定',
                    reportTime: '',
                    status: '未配置',
                    remarks: '未配置',
                    receptionTime: '',
                    phoneNumber: `000000000${i}`,
                    lineId: `unassigned.${i}`,
                    lastWorkDate: `2025/06/${String(1 + i).padStart(2, '0')}`,
                    assignmentStatus: '未配置',
                    consecutiveWorkStatus: randomConsecutiveStatus,
                    holidayStatus: holidayStatus,
                    siteAddress: '未定', // Unassigned personnel don't have a specific site address
                    siteSupervisor: '未定' // Added site supervisor for unassigned
                });
            }

            allTableData.push(...newUnassignedEntries);
            allTableData.sort((a, b) => a.no - b.no);


            let unassignedPersonnelData = allTableData.filter(item => item.assignmentStatus === '未配置');


            let displayedTableData = [...allTableData];
            let mainSearchTerm = ''; // New variable for main screen search

            let currentSortKey = null;
            let currentSortDirection = 'asc';

            let selectedSummaryBranches = [...allBranches];
            let showOnlyPending = false;

            let unassignedSearchTerm = '';
            let selectedUnassignedBranches = [...allBranches];
            let unassignedCurrentSortKey = null;
            let unassignedCurrentSortDirection = 'asc';

            let workHistorySearchTerm = '';
            let selectedWorkHistoryBranches = [...allBranches];
            let workHistoryCurrentSortKey = null;
            let workHistoryCurrentSortDirection = 'asc';
            let currentWorkHistoryAssignment = '';
            let showOnlyUnassignedInWorkHistory = false;


            let currentView = 'main';

            // Sample data for accounts - Added to fix the Account Settings Modal
            let accounts = [
                {
                    id: 1,
                    name: '管理者A',
                    email: 'admin.a@example.com',
                    notificationSettings: { departure: 60, start: 10, end: 10 },
                    notificationBranches: ['福岡支店', '東京支店'],
                    devices: ['PC (Chrome)', 'スマートフォン (Android)'],
                    attendanceDisplayBranches: ['福岡支店', '東京支店', '大阪支店']
                },
                {
                    id: 2,
                    name: '管理者B',
                    email: 'admin.b@example.com',
                    notificationSettings: { departure: 30, start: 5, end: 15 },
                    notificationBranches: ['大阪支店'],
                    devices: ['タブレット (iPad)'],
                    attendanceDisplayBranches: ['大阪支店']
                }
            ];


            function updateScreenVisibility() {
                mainAppContent.classList.add('hidden');
                switchedScreenContent.classList.add('hidden');
                unassignedPersonnelScreen.classList.add('hidden');
                workHistoryScreen.classList.add('hidden');

                if (currentView === 'main') {
                    mainAppContent.classList.remove('hidden');
                    filterAndRenderMainTable(); // Call new filter function for main table
                } else if (currentView === 'summary') {
                    switchedScreenContent.classList.remove('hidden');
                    populateBranchFilterCheckboxes();
                    filterAndRenderSummary();
                } else if (currentView === 'unassigned') {
                    unassignedPersonnelScreen.classList.remove('hidden');
                    selectedUnassignedBranches = [...allBranches];
                    unassignedSearchInput.value = '';
                    unassignedCurrentSortKey = null; // Reset sort for unassigned screen
                    unassignedCurrentSortDirection = 'asc';
                    populateUnassignedBranchFilterCheckboxes();
                    filterAndRenderUnassignedPersonnelTable();
                } else if (currentView === 'work-history') {
                    workHistoryScreen.classList.remove('hidden');
                    selectedWorkHistoryBranches = [...allBranches];
                    workHistorySearchInput.value = '';
                    showOnlyUnassignedInWorkHistory = false;
                    if (workHistoryUnassignedFilterButton) {
                        workHistoryUnassignedFilterButton.classList.remove('bg-yellow-600');
                    }
                    workHistoryCurrentSortKey = null; // Reset sort for work history screen
                    workHistoryCurrentSortDirection = 'asc';
                    populateWorkHistoryBranchFilterCheckboxes();
                    filterAndRenderWorkHistoryTable();
                }
                updateAllDateDisplays();
            }

            function filterAndRenderMainTable() {
                let filteredData = [...allTableData];

                // Filter out '未配置' status for the main table
                filteredData = filteredData.filter(item => item.status !== '未配置');

                // Apply status filter from dropdown
                const selectedStatus = statusSearchSelect.value;
                if (selectedStatus) {
                    filteredData = filteredData.filter(row => row.status === selectedStatus);
                }

                // Apply text search filter
                const searchTermLower = mainSearchInput.value.toLowerCase().trim();
                if (searchTermLower) {
                    filteredData = filteredData.filter(row =>
                        row.teamMember.toLowerCase().includes(searchTermLower) ||
                        row.client.toLowerCase().includes(searchTermLower) ||
                        row.assignment.toLowerCase().includes(searchTermLower)
                    );
                }

                // Apply sorting
                if (currentSortKey) {
                    filteredData = sortTableData(filteredData, currentSortKey, currentSortDirection);
                }
                
                renderTable(filteredData);
            }

            function renderTable(dataToRender) {
                tableBody.innerHTML = '';

                if (dataToRender.length === 0) {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="11" class="px-6 py-4 text-sm text-gray-500 text-center">表示するデータがありません。</td>`;
                    tableBody.appendChild(noDataRow);
                    return;
                }

                dataToRender.forEach(rowData => {
                    const row = document.createElement('tr');
                    
                    // Apply light yellow background if status is '報告待ち'
                    if (rowData.status === '報告待ち') {
                        row.classList.add('bg-yellow-50');
                    }

                    // Add hover effect for all rows except the one with no: 4
                    // If rowData.no is 4, do NOT add 'hover:bg-gray-50'
                    if (rowData.no !== 4) {
                        row.classList.add('hover:bg-gray-50');
                    }
                    // No need for 'no-hover-effect' class or CSS rule anymore,
                    // as we conditionally apply 'hover:bg-gray-50' directly.


                    const noCell = document.createElement('td');
                    noCell.classList.add('px-6', 'py-4', 'text-sm', 'font-medium', 'text-gray-900', 'text-center');
                    noCell.textContent = rowData.no;
                    row.appendChild(noCell);

                    const teamMemberCell = document.createElement('td');
                    teamMemberCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-900', 'whitespace-nowrap', 'min-w-40');
                    const teamMemberDiv = document.createElement('div');
                    teamMemberDiv.classList.add('flex', 'items-center', 'justify-center');
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = rowData.teamMember;
                    teamMemberDiv.appendChild(nameSpan);
                    
                    const phoneIconSvg = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-phone cursor-pointer text-gray-500 hover:text-gray-700 transition-colors">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-3.67-3.67A19.79 19.79 0 0 1 2 5.18 2 2 0 0 1 4.11 3h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                    `;
                    const phoneIconWrapper = document.createElement('span');
                    phoneIconWrapper.classList.add('ml-2');
                    phoneIconWrapper.innerHTML = phoneIconSvg;
                    phoneIconWrapper.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent row click from firing
                        openPhoneCallModal(rowData.teamMember, rowData.phoneNumber);
                    });
                    teamMemberDiv.appendChild(phoneIconWrapper);
                    teamMemberCell.appendChild(teamMemberDiv);
                    row.appendChild(teamMemberCell);

                    const branchCell = document.createElement('td');
                    branchCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-900', 'text-center');
                    branchCell.textContent = rowData.branch;
                    row.appendChild(branchCell);

                    const clientCell = document.createElement('td');
                    clientCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-900', 'text-center');
                    clientCell.textContent = rowData.client;
                    row.appendChild(clientCell);

                    const assignmentCell = document.createElement('td');
                    // Removed 'underline' and 'text-blue-600' classes
                    assignmentCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-900', 'text-center', 'cursor-pointer');
                    assignmentCell.textContent = rowData.assignment;
                    assignmentCell.addEventListener('click', () => {
                        openAssignmentDetailModal(rowData);
                    });
                    // Add mouseover and mouseout for tooltip
                    assignmentCell.addEventListener('mouseover', (event) => showTooltip(event, '詳細を確認する'));
                    assignmentCell.addEventListener('mouseout', hideTooltip);
                    row.appendChild(assignmentCell);

                    const workContentCell = document.createElement('td');
                    workContentCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-900', 'whitespace-nowrap');
                    const workContentDiv = document.createElement('div');
                    workContentDiv.classList.add('flex', 'items-center', 'justify-center');
                    const workContentSpan = document.createElement('span');
                    workContentSpan.textContent = rowData.workContent;
                    workContentDiv.appendChild(workContentSpan);
                    if (rowData.workContent === '日勤') {
                        const sunIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                        sunIcon.setAttribute('width', '16');
                        sunIcon.setAttribute('height', '16');
                        sunIcon.setAttribute('viewBox', '0 0 24 24');
                        sunIcon.setAttribute('fill', 'none');
                        sunIcon.setAttribute('stroke', 'currentColor');
                        sunIcon.setAttribute('stroke-width', '2');
                        sunIcon.setAttribute('stroke-linecap', 'round');
                        sunIcon.setAttribute('stroke-linejoin', 'round');
                        sunIcon.classList.add('lucide', 'lucide-sun', 'ml-1', 'text-orange-500');
                        sunIcon.innerHTML = '<circle cx="12" cy="12" r="8"/><line x1="12" x2="12" y1="2" y2="4"/><line x1="12" x2="12" y1="20" y2="22"/><line x1="4.22" x2="5.64" y1="4.22" y2="5.64"/><line x1="18.36" x2="19.78" y1="18.36" y2="19.78"/><line x1="2" x2="4" y1="12" y2="12"/><line x1="20" x2="22" y1="12" y2="12"/><line x1="4.22" x2="5.64" y1="19.78" y2="18.36"/><line x1="18.36" x2="19.78" y1="5.64" y2="4.22"/>';
                        workContentDiv.appendChild(sunIcon);
                    } else if (rowData.workContent === '夜勤') {
                        const moonIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                        moonIcon.setAttribute('width', '16');
                        moonIcon.setAttribute('height', '16');
                        moonIcon.setAttribute('viewBox', '0 0 24 24');
                        moonIcon.setAttribute('fill', 'none');
                        moonIcon.setAttribute('stroke', 'currentColor');
                        moonIcon.setAttribute('stroke-width', '2');
                        moonIcon.setAttribute('stroke-linecap', 'round');
                        moonIcon.setAttribute('stroke-linejoin', 'round');
                        moonIcon.classList.add('lucide', 'lucide-moon', 'ml-1', 'text-blue-500');
                        moonIcon.innerHTML = '<path d="M12 3a6.36 6.36 0 0 0 9 9 9 9 0 1 1-9-9Z"/>';
                        workContentDiv.appendChild(moonIcon);
                    }
                    workContentCell.appendChild(workContentDiv);
                    row.appendChild(workContentCell);

                    const baseTimeCell = document.createElement('td');
                    baseTimeCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-900');
                    baseTimeCell.textContent = rowData.baseTime;
                    row.appendChild(baseTimeCell);

                    const reportTimeCell = document.createElement('td');
                    reportTimeCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-900');
                    reportTimeCell.textContent = rowData.reportTime;
                    row.appendChild(reportTimeCell);

                    const statusCell = document.createElement('td');
                    statusCell.classList.add('px-6', 'py-4', 'text-sm', 'text-center');
                    
                    const statusTagSpan = document.createElement('span');
                    statusTagSpan.classList.add('status-tag');
                    statusTagSpan.textContent = rowData.status === '勤務中' ? '勤 務 中' : rowData.status;

                    if (rowData.status === '下番完了') {
                        statusTagSpan.classList.add('status-tag-completed');
                    } else if (rowData.status === '報告待ち') {
                        statusTagSpan.classList.add('status-tag-pending');
                    } else if (rowData.status === '勤務中') {
                        statusTagSpan.classList.add('status-tag-in-progress');
                    }
                    
                    statusCell.appendChild(statusTagSpan);
                    row.appendChild(statusCell);

                    const remarksCell = document.createElement('td');
                    remarksCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-900', 'text-center');
                    remarksCell.textContent = rowData.remarks;
                    row.appendChild(remarksCell);

                    const receptionTimeCell = document.createElement('td');
                    receptionTimeCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-900', 'text-center');
                    receptionTimeCell.textContent = rowData.receptionTime;
                    row.appendChild(receptionTimeCell);

                    tableBody.appendChild(row);
                });
            }

            function sortTableData(data, key, direction) {
                return data.sort((a, b) => {
                    let valA = a[key];
                    let valB = b[key];

                    if (key === 'no') {
                        valA = Number(valA);
                        valB = Number(valB);
                        return (valA - valB) * (direction === 'asc' ? 1 : -1);
                    } else if (key === 'receptionTime' || key === 'lastWorkDate') {
                        return String(valA).localeCompare(String(valB)) * (direction === 'asc' ? 1 : -1);
                    } else {
                        return String(valA).localeCompare(String(valB)) * (direction === 'asc' ? 1 : -1);
                    }
                });
            }

            function updateGenericSortIndicators(headers, currentKey, currentDirection) {
                headers.forEach(header => {
                    const indicator = header.querySelector('.sort-indicator');
                    if (indicator) {
                        indicator.classList.remove('active', 'asc', 'desc');
                        if (header.dataset.sortKey === currentKey) {
                            indicator.classList.add('active');
                            indicator.classList.add(currentDirection);
                        }
                    }
                });
            }

            document.querySelectorAll('#table-container th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sortKey;
                    if (sortKey) {
                        if (currentSortKey === sortKey) {
                            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentSortKey = sortKey;
                            currentSortDirection = 'asc';
                        }
                        filterAndRenderMainTable(); // Use the new filter function
                        updateGenericSortIndicators(document.querySelectorAll('#table-container th[data-sort-key]'), currentSortKey, currentSortDirection);
                    }
                });
            });

            function formatTimestamp(timestamp) {
                const date = new Date(timestamp);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}/${month}/${day} ${hours}:${minutes}`;
            }

            let notificationHistory = [
                { id: 1, message: 'No.4 山田 太郎さんの報告が来ておりません', isRead: false, timestamp: Date.now() },
                { id: 2, message: 'システムリリース(ver1.0.0.0)に関するお知らせです。', isRead: true, timestamp: new Date('2025-01-01T10:00:00').getTime(), displayTimestamp: '2025/xx/xx xx:xx' },
                { id: 3, message: 'システムリリース(ver1.0.0.1)に関するお知らせです。', isRead: true, timestamp: new Date('2025-01-02T11:00:00').getTime(), displayTimestamp: '2025/xx/xx xx:xx' },
                { id: 4, message: 'システムリリース(ver1.0.0.2)に関するお知らせです。', isRead: true, timestamp: new Date('2025-01-03T12:00:00').getTime(), displayTimestamp: '2025/xx/xx xx:xx' },
                { id: 5, message: 'システムリリース(ver1.0.0.3)に関するお知らせです。', isRead: true, timestamp: new Date('2025-01-04T13:00:00').getTime(), displayTimestamp: '2025/xx/xx xx:xx' },
                { id: 6, message: 'システムリリース(ver1.0.0.4)に関するお知らせです。', isRead: true, timestamp: new Date('2025-01-05T14:00:00').getTime(), displayTimestamp: '2025/xx/xx xx:xx' },
                { id: 8, message: 'システムリリース(ver1.0.0.6)に関するお知らせです。', isRead: true, timestamp: new Date('2025-01-07T16:00:00').getTime(), displayTimestamp: '2025/xx/xx xx:xx' }
            ];

            const targetMessage = 'No.4 山田 太郎さんの報告が来ておりません';
            const fixedDate = new Date('2025-06-28T21:00:00');
            const fixedTimestamp = fixedDate.getTime();
            const fixedDisplayTimestamp = '2025/06/28 21:00';

            const notificationToUpdate = notificationHistory.find(notif => notif.message === targetMessage);
            if (notificationToUpdate) {
                notificationToUpdate.timestamp = fixedTimestamp;
                notificationToUpdate.displayTimestamp = fixedDisplayTimestamp;
            } else {
                notificationHistory.unshift({
                    id: Date.now(),
                    message: targetMessage,
                    isRead: false,
                    timestamp: fixedTimestamp,
                    displayTimestamp: fixedDisplayTimestamp
                });
            }

            function updateNotificationBadge() {
                const unreadCount = notificationHistory.filter(notif => !notif.isRead).length;
                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount.toString();
                    notificationBadge.classList.remove('hidden');
                } else {
                    notificationBadge.textContent = '';
                    notificationBadge.classList.add('hidden');
                }
            }

            function renderNotifications() {
                sideMenuContentArea.innerHTML = '';

                if (notificationHistory.length === 0) {
                    const noNotifMessage = document.createElement('div');
                    noNotifMessage.classList.add('text-gray-500', 'text-center', 'py-4');
                    noNotifMessage.textContent = '通知はありません。';
                    sideMenuContentArea.appendChild(noNotifMessage);
                    return;
                }

                notificationHistory.sort((a, b) => {
                    if (!a.isRead && b.isRead) { return -1; }
                    if (a.isRead && !b.isRead) { return 1; }
                    if (!a.isRead && !b.isRead) { return b.timestamp - a.timestamp; }
                    else { return a.timestamp - b.timestamp; }
                });

                notificationHistory.forEach(notif => {
                    const notifElement = document.createElement('div');
                    notifElement.classList.add('side-menu-item');
                    if (!notif.isRead) {
                        notifElement.classList.add('font-semibold', 'text-gray-900');
                    } else {
                        notifElement.classList.add('text-gray-500');
                    }
                    
                    const displayedTime = notif.isRead && notif.displayTimestamp ? notif.displayTimestamp : formatTimestamp(notif.timestamp);
                    
                    notifElement.innerHTML = `<div>${notif.message}</div><div class="text-xs text-gray-400 mt-1">${displayedTime}</div>`;
                    sideMenuContentArea.appendChild(notifElement);

                    notifElement.addEventListener('click', () => {
                        notif.isRead = true;
                        renderNotifications();
                        updateNotificationBadge();
                    });
                });
            }

            function renderOptionsMenu() {
                sideMenuContentArea.innerHTML = '';
                dynamicSideMenuTitle.textContent = '';
                dynamicSideMenuTitle.classList.add('hidden');

                const lineNotifItem = document.createElement('div');
                lineNotifItem.classList.add('side-menu-item');
                lineNotifItem.textContent = 'LINE通知';
                lineNotifItem.addEventListener('click', () => {
                    sideMenuContainer.classList.remove('open');
                    lineNotificationSettingsModal.classList.add('open');
                    renderLineMemberTable();
                });
                sideMenuContentArea.appendChild(lineNotifItem);

                const accountSettingsItem = document.createElement('div');
                accountSettingsItem.classList.add('side-menu-item');
                accountSettingsItem.textContent = 'アカウント設定';
                accountSettingsItem.addEventListener('click', () => {
                    sideMenuContainer.classList.remove('open');
                    openAccountSettingsModal();
                });
                sideMenuContentArea.appendChild(accountSettingsItem);
                
                const termsPrivacyItem = document.createElement('div');
                termsPrivacyItem.classList.add('side-menu-item');
                termsPrivacyItem.textContent = '利用規約 / プライバシーポリシー';
                termsPrivacyItem.addEventListener('click', () => {
                    console.log('利用規約およびプライバシーポリシーのページへ遷移します。');
                    sideMenuContainer.classList.remove('open');
                });
                sideMenuContentArea.appendChild(termsPrivacyItem);

                const logoutItem = document.createElement('div');
                logoutItem.classList.add('side-menu-item');
                logoutItem.textContent = 'ログアウト';
                logoutItem.addEventListener('click', () => {
                    console.log('ログアウトしました。');
                    sideMenuContainer.classList.remove('open');
                });
                sideMenuContentArea.appendChild(logoutItem);
            }

            function renderLineMemberTable() {
                const lineMemberTableBody = document.getElementById('line-member-table-body');
                lineMemberTableBody.innerHTML = '';

                // Take only the first 6 members for the LINE notification table
                const membersForLineTable = allTableData.slice(0, 6);

                membersForLineTable.forEach(rowData => {
                    const row = document.createElement('tr');

                    const noBranchCell = document.createElement('td');
                    noBranchCell.classList.add('px-4', 'py-2', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    noBranchCell.innerHTML = `
                        <span class="text-gray-400 text-xxs font-normal block">NO: ${String(rowData.no).padStart(2, '0')}</span>
                        <span>${rowData.branch}</span>
                    `;
                    noBranchCell.setAttribute('aria-label', `NO ${rowData.no}, Branch ${rowData.branch}`);
                    row.appendChild(noBranchCell);

                    const noTeamMemberCell = document.createElement('td');
                    noTeamMemberCell.classList.add('px-4', 'py-2', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    noTeamMemberCell.innerHTML = `
                        <span class="text-gray-400 text-xxs font-normal block">NO: ${String(rowData.no).padStart(6, '0')}</span>
                        <span>${rowData.teamMember}</span>
                    `;
                    noTeamMemberCell.setAttribute('aria-label', `NO ${rowData.no}, Team Member ${rowData.teamMember}`);
                    noTeamMemberCell.appendChild(document.createTextNode(' '));
                    row.appendChild(noTeamMemberCell);

                    const lineIdCell = document.createElement('td');
                    lineIdCell.classList.add('px-4', 'py-2', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    const lineIdInput = document.createElement('input');
                    lineIdInput.type = 'text';
                    lineIdInput.value = rowData.lineId;
                    lineIdInput.classList.add('w-full', 'p-1', 'border', 'border-gray-300', 'rounded-md', 'text-sm', 'text-gray-900');
                    lineIdInput.setAttribute('aria-label', `LINE ID for ${rowData.teamMember}`);
                    lineIdCell.appendChild(lineIdInput);
                    row.appendChild(lineIdCell);

                    lineMemberTableBody.appendChild(row);
                });
            }

            updateNotificationBadge();

            if (notificationButton) {
                notificationButton.addEventListener('click', () => {
                    dynamicSideMenuTitle.textContent = '通知';
                    dynamicSideMenuTitle.classList.remove('hidden');

                    const newNotificationMessage = 'No.4 山田 太郎さんの報告が来ておりません';
                    const fixedDate = new Date('2025-06-28T21:00:00');
                    const fixedTimestamp = fixedDate.getTime();
                    const fixedDisplayTimestamp = '2025/06/28 21:00';

                    const existingFixedNotification = notificationHistory.find(notif =>
                        notif.message === targetMessage && notif.timestamp === fixedTimestamp
                    );

                    if (!existingFixedNotification) {
                        const index = notificationHistory.findIndex(notif => notif.message === targetMessage);
                        if (index !== -1) {
                            notificationHistory[index].timestamp = fixedTimestamp;
                            notificationHistory[index].displayTimestamp = fixedDisplayTimestamp;
                            notificationHistory[index].isRead = false;
                        } else {
                            notificationHistory.unshift({
                                id: Date.now(),
                                message: newNotificationMessage,
                                isRead: false,
                                timestamp: fixedTimestamp,
                                displayTimestamp: fixedDisplayTimestamp
                            });
                        }
                    }

                    renderNotifications();
                    updateNotificationBadge();
                    sideMenuContainer.classList.add('open');
                });
            }

            if (optionsButton) {
                optionsButton.addEventListener('click', () => {
                    dynamicSideMenuTitle.textContent = '';
                    dynamicSideMenuTitle.classList.add('hidden');
                    renderOptionsMenu();
                    sideMenuContainer.classList.add('open');
                });
            }

            if (sideMenuCloseButton) {
                sideMenuCloseButton.addEventListener('click', () => {
                    sideMenuContainer.classList.remove('open');
                });
            }

            if (sideMenuContainer) {
                sideMenuContainer.addEventListener('click', (event) => {
                    if (event.target === sideMenuContainer) {
                        sideMenuContainer.classList.remove('open');
                    }
                });
            }

            function navigateDay(days) {
                currentSystemDate.setDate(currentSystemDate.getDate() + days);
                updateAllDateDisplays();
                if (currentView === 'main') {
                    filterAndRenderMainTable(); // Use the new filter function
                } else if (currentView === 'summary') {
                    filterAndRenderSummary();
                } else if (currentView === 'unassigned') {
                    filterAndRenderUnassignedPersonnelTable();
                } else if (currentView === 'work-history') {
                    filterAndRenderWorkHistoryTable();
                }
            }

            if (mainPrevDayButton) { mainPrevDayButton.addEventListener('click', () => navigateDay(-1)); }
            if (mainNextDayButton) { mainNextDayButton.addEventListener('click', () => navigateDay(1)); }
            if (mainCalendarButton) {
                mainCalendarButton.addEventListener('click', () => {
                    currentCalendarDate = new Date(currentSystemDate);
                    renderCalendar(currentCalendarDate);
                    calendarModal.classList.add('open');
                });
            }

            if (summaryPrevDayButton) { summaryPrevDayButton.addEventListener('click', () => navigateDay(-1)); }
            if (summaryNextDayButton) { summaryNextDayButton.addEventListener('click', () => navigateDay(1)); }
            if (summaryCalendarButton) {
                summaryCalendarButton.addEventListener('click', () => {
                    currentCalendarDate = new Date(currentSystemDate);
                    renderCalendar(currentCalendarDate);
                    calendarModal.classList.add('open');
                });
            }

            if (unassignedPrevDayButton) { unassignedPrevDayButton.addEventListener('click', () => navigateDay(-1)); }
            if (unassignedNextDayButton) { unassignedNextDayButton.addEventListener('click', () => navigateDay(1)); }
            if (unassignedCalendarButton) {
                unassignedCalendarButton.addEventListener('click', () => {
                    currentCalendarDate = new Date(currentSystemDate);
                    renderCalendar(currentCalendarDate);
                    calendarModal.classList.add('open');
                });
            }

            if (workHistoryPrevDayButton) { workHistoryPrevDayButton.addEventListener('click', () => navigateDay(-1)); }
            if (workHistoryNextDayButton) { workHistoryNextDayButton.addEventListener('click', () => navigateDay(1)); }
            if (workHistoryCalendarButton) {
                workHistoryCalendarButton.addEventListener('click', () => {
                    currentCalendarDate = new Date(currentSystemDate);
                    renderCalendar(currentCalendarDate);
                    calendarModal.classList.add('open');
                });
            }


            if (calendarModalCloseButton) {
                calendarModalCloseButton.addEventListener('click', () => {
                    calendarModal.classList.remove('open');
                });
            }

            if (calendarModal) {
                calendarModal.addEventListener('click', (event) => {
                    if (event.target === calendarModal) {
                        closeCalendarModal();
                    }
                });
            }
            function closeCalendarModal() {
                calendarModal.classList.remove('open');
            }

            function renderCalendar(date) {
                const year = date.getFullYear();
                const month = date.getMonth();

                calendarMonthYear.textContent = `${year}年 ${month + 1}月`;

                // Remove all children except the first 7 (day labels)
                while (calendarGrid.children.length > 7) {
                    calendarGrid.removeChild(calendarGrid.lastChild);
                }

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptySpan = document.createElement('span');
                    emptySpan.textContent = '';
                    calendarGrid.appendChild(emptySpan);
                }

                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const daySpan = document.createElement('span');
                    daySpan.textContent = day;
                    daySpan.classList.add('current-month');
                    
                    const currentDayOfWeek = new Date(year, month, day).getDay();

                    if (currentDayOfWeek === 0) { daySpan.classList.add('sunday'); } else if (currentDayOfWeek === 6) { daySpan.classList.add('saturday'); }

                    if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                        daySpan.classList.add('today');
                    }
                    daySpan.addEventListener('click', (event) => {
                        const selectedDay = parseInt(event.target.textContent);
                        currentSystemDate = new Date(year, month, selectedDay);
                        updateAllDateDisplays();
                        calendarModal.classList.remove('open');
                        if (currentView === 'main') {
                            filterAndRenderMainTable(); // Use the new filter function
                        } else if (currentView === 'summary') {
                            filterAndRenderSummary();
                        } else if (currentView === 'unassigned') {
                            filterAndRenderUnassignedPersonnelTable();
                        } else if (currentView === 'work-history') {
                            filterAndRenderWorkHistoryTable();
                        }
                    });
                    calendarGrid.appendChild(daySpan);
                }
            }

            // Calendar navigation buttons event listeners (added to fix calendar functionality)
            if (prevMonthButton) {
                prevMonthButton.addEventListener('click', () => {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                    renderCalendar(currentCalendarDate);
                });
            }
            if (nextMonthButton) {
                nextMonthButton.addEventListener('click', () => {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                    renderCalendar(currentCalendarDate);
                });
            }


            if (statusSearchSelect) {
                statusSearchSelect.addEventListener('change', () => {
                    filterAndRenderMainTable(); // Use the new filter function
                });
            }

            // New: Event listener for main search input
            if (mainSearchInput) {
                mainSearchInput.addEventListener('input', () => {
                    filterAndRenderMainTable(); // Trigger re-render on search input
                });
            }


            if (lineNotificationModalCloseButton) {
                lineNotificationModalCloseButton.addEventListener('click', () => {
                    lineNotificationSettingsModal.classList.remove('open');
                });
            }

            if (lineNotificationSettingsModal) {
                lineNotificationSettingsModal.addEventListener('click', (event) => {
                    if (event.target === lineNotificationSettingsModal) {
                        lineNotificationSettingsModal.classList.remove('open');
                    }
                });
            }

            if (saveLineSettingsButton) {
                saveLineSettingsButton.addEventListener('click', () => {
                    const departureTime = document.getElementById('departure-time').value;
                    const startReportTime = document.getElementById('start-report-time').value;
                    const endReportTime = document.getElementById('end-report-time').value;
                    
                    const lineIdInputs = lineNotificationSettingsModal.querySelectorAll('#line-member-table-body input[type="text"]');
                    let lineIds = [];
                    lineIdInputs.forEach((input, index) => {
                        // Ensure we only update the first 6 members that are displayed
                        if (index < 6) {
                            allTableData[index].lineId = input.value;
                        }
                        lineIds.push(input.value);
                    });

                    console.log(`LINE通知設定を保存しました:\n自宅出発: ${departureTime}分前\n上番報告: ${startReportTime}分前\n下番報告: ${endReportTime}分後\nLINE IDs: ${lineIds.join(', ')}`);
                    lineNotificationSettingsModal.classList.remove('open');
                });
            }

            if (cancelLineSettingsButton) {
                cancelLineSettingsButton.addEventListener('click', () => {
                    console.log('LINE通知設定の変更を取消しました。');
                    lineNotificationSettingsModal.classList.remove('open');
                });
            }

            function openPhoneCallModal(teamMemberName, phoneNumber) {
                phoneCallModalTitle.textContent = `${teamMemberName}に電話`;
                phoneCallModalNumber.textContent = phoneNumber;
                phoneCallModal.classList.add('open');
                callButton.dataset.phoneNumber = phoneNumber;
            }

            function closePhoneCallModal() {
                phoneCallModal.classList.remove('open');
            }

            if (phoneCallModalCloseButton) {
                phoneCallModalCloseButton.addEventListener('click', closePhoneCallModal);
            }

            if (phoneCallModal) {
                phoneCallModal.addEventListener('click', (event) => {
                    if (event.target === phoneCallModal) {
                        closePhoneCallModal();
                    }
                });
            }

            if (callButton) {
                callButton.addEventListener('click', () => {
                    const phoneNumber = callButton.dataset.phoneNumber;
                    if (phoneNumber) {
                        window.location.href = `tel:${phoneNumber}`;
                        closePhoneCallModal();
                    }
                });
            }

            if (cancelCallButton) {
                cancelCallButton.addEventListener('click', closePhoneCallModal);
            }

            function openAccountSettingsModal() {
                renderAccountList();
                accountSettingsModal.classList.add('open');
            }

            function closeAccountSettingsModal() {
                accountSettingsModal.classList.remove('open');
            }

            function renderAccountList() {
                accountListArea.innerHTML = '';
                if (accounts.length === 0) {
                    const noAccountsMessage = document.createElement('div');
                    noAccountsMessage.classList.add('text-gray-500', 'text-center', 'py-4');
                    noAccountsMessage.textContent = 'アカウントは登録されていません。';
                    accountListArea.appendChild(noAccountsMessage);
                    return;
                }
                accounts.forEach(account => {
                    const accountItem = document.createElement('div');
                    accountItem.classList.add('account-list-item');
                    accountItem.innerHTML = `
                        <span>${account.name} (${account.email})</span>
                        <button class="settings-icon" data-account-id="${account.id}">⚙</button>
                    `;
                    accountItem.querySelector('.settings-icon').addEventListener('click', (event) => {
                        const accountId = parseInt(event.currentTarget.dataset.accountId);
                        const selectedAccount = accounts.find(acc => acc.id === accountId);
                        if (selectedAccount) {
                            openIndividualAccountSettingsModal(selectedAccount);
                        }
                    });
                    accountListArea.appendChild(accountItem);
                });
            }

            if (accountSettingsModalCloseButton) {
                accountSettingsModalCloseButton.addEventListener('click', closeAccountSettingsModal);
            }

            if (accountSettingsModal) {
                accountSettingsModal.addEventListener('click', (event) => {
                    if (event.target === accountSettingsModal) {
                        closeAccountSettingsModal();
                    }
                });
            }

            if (addAccountButton) {
                addAccountButton.addEventListener('click', () => {
                    console.log('新しいアカウントを追加します。');
                });
            }

            function openIndividualAccountSettingsModal(account) {
                closeAccountSettingsModal();
                
                individualAccountSettingsTitle.textContent = `アカウント設定: ${account.name}`;
                
                individualDepartureTime.value = account.notificationSettings.departure;
                individualStartReportTime.value = account.notificationSettings.start;
                individualEndReportTime.value = account.notificationSettings.end;

                const allBranches = [...new Set(allTableData.map(item => item.branch))].sort();

                notificationBranchesCheckboxes.innerHTML = '';
                allBranches.forEach(branch => {
                    const checkboxContainer = document.createElement('label');
                    checkboxContainer.classList.add('inline-flex', 'items-center', 'w-1/2');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = branch;
                    checkbox.classList.add('form-checkbox', 'h-5', 'w-5', 'text-blue-600', 'rounded');
                    checkbox.checked = account.notificationBranches.includes(branch);
                    checkbox.setAttribute('aria-label', `通知支店: ${branch}`);
                    checkboxContainer.appendChild(checkbox);
                    checkboxContainer.appendChild(document.createTextNode(` ${branch}`));
                    notificationBranchesCheckboxes.appendChild(checkboxContainer);
                });
                
                notificationDeviceList.innerHTML = '';
                if (account.devices && account.devices.length > 0) {
                    account.devices.forEach(device => {
                        const deviceItem = document.createElement('div');
                        deviceItem.classList.add('device-list-item');
                        deviceItem.innerHTML = `
                            <span>${device} (登録済み)</span>
                            <button class="device-action-button">削除</button>
                        `;
                        deviceItem.querySelector('.device-action-button').addEventListener('click', () => {
                            console.log(`${device} を削除します。`);
                        });
                        notificationDeviceList.appendChild(deviceItem);
                    });
                } else {
                    const noDevicesMessage = document.createElement('div');
                    noDevicesMessage.classList.add('text-gray-500', 'text-center', 'py-2');
                    noDevicesMessage.textContent = '登録された通知端末はありません。';
                    notificationDeviceList.appendChild(noDevicesMessage);
                }

                attendanceDisplayBranchesCheckboxes.innerHTML = '';
                allBranches.forEach(branch => {
                    const checkboxContainer = document.createElement('label');
                    checkboxContainer.classList.add('inline-flex', 'items-center', 'w-1/2');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = branch;
                    checkbox.classList.add('form-checkbox', 'h-5', 'w-5', 'text-blue-600', 'rounded');
                    checkbox.checked = account.attendanceDisplayBranches.includes(branch);
                    checkbox.setAttribute('aria-label', `勤怠表示支店: ${branch}`);
                    checkboxContainer.appendChild(checkbox);
                    checkboxContainer.appendChild(document.createTextNode(` ${branch}`));
                    attendanceDisplayBranchesCheckboxes.appendChild(checkboxContainer);
                });


                individualAccountSettingsModal.classList.add('open');
            }

            function closeIndividualAccountSettingsModal() {
                individualAccountSettingsModal.classList.remove('open');
            }

            if (individualAccountSettingsModalCloseButton) {
                individualAccountSettingsModalCloseButton.addEventListener('click', closeIndividualAccountSettingsModal);
            }

            if (individualAccountSettingsModal) {
                individualAccountSettingsModal.addEventListener('click', (event) => {
                    if (event.target === individualAccountSettingsModal) {
                        closeIndividualAccountSettingsModal();
                    }
                });
            }

            if (addNotificationDeviceButton) {
                addNotificationDeviceButton.addEventListener('click', () => {
                    console.log('新しい通知端末を追加します。');
                });
            }

            if (changePasswordButton) {
                changePasswordButton.addEventListener('click', () => {
                    console.log('パスワード変更画面へ遷移します。');
                });
            }

            if (deleteAccountButton) {
                deleteAccountButton.addEventListener('click', () => {
                    console.log('このアカウントを削除します。');
                });
            }

            if (saveIndividualAccountSettingsButton) {
                saveIndividualAccountSettingsButton.addEventListener('click', () => {
                    const departure = individualDepartureTime.value;
                    const start = individualStartReportTime.value;
                    const dataForWorkHistory = individualEndReportTime.value;

                    const selectedNotificationBranches = Array.from(notificationBranchesCheckboxes.querySelectorAll('input:checked'))
                                                                .map(cb => cb.value);

                    const selectedAttendanceDisplayBranches = Array.from(attendanceDisplayBranchesCheckboxes.querySelectorAll('input:checked'))
                                                                    .map(cb => cb.value);

                    console.log(`アカウント設定を保存しました:\n` +
                                `自宅出発: ${departure}分前\n` +
                                `上番報告: ${start}分前\n` +
                                `下番報告: ${dataForWorkHistory}分後\n` +
                                `通知支店: ${selectedNotificationBranches.join(', ')}\n` +
                                `勤怠表示支店: ${selectedAttendanceDisplayBranches.join(', ')}`);
                    closeIndividualAccountSettingsModal();
                });
            }

            if (cancelIndividualAccountSettingsButton) {
                cancelIndividualAccountSettingsButton.addEventListener('click', () => {
                    console.log('アカウント設定の変更を取消しました。');
                    closeIndividualAccountSettingsModal();
                });
            }

            function renderAssignmentSummary(dataToRender) {
                assignmentSummaryContainer.innerHTML = '';

                const groupedAssignments = {};

                const assignedData = dataToRender.filter(item => item.assignmentStatus !== '未配置');

                assignedData.forEach(item => {
                    const assignment = item.assignment;
                    if (!groupedAssignments[assignment]) {
                        groupedAssignments[assignment] = {
                            client: item.client,
                            workContent: item.workContent,
                            baseTime: item.baseTime,
                            totalAssignedMembers: [],
                            inProgressMembers: [],
                            pendingReportMembers: []
                        };
                    }
                    groupedAssignments[assignment].totalAssignedMembers.push(item.teamMember);
                    if (item.status === '勤務中') {
                        groupedAssignments[assignment].inProgressMembers.push(item.teamMember);
                    } else if (item.status === '報告待ち') {
                        groupedAssignments[assignment].pendingReportMembers.push(item.teamMember);
                    }
                });

                let sortedAssignments = Object.keys(groupedAssignments).map(key => ({
                    assignment: key,
                    ...groupedAssignments[key]
                }));

                sortedAssignments.sort((a, b) => {
                    if (a.assignment === '新宿駅東口再開発') return -1;
                    if (b.assignment === '新宿駅東口再開発') return 1;
                    return a.assignment.localeCompare(b.assignment);
                });

                if (sortedAssignments.length === 0) {
                    const noAssignmentsMessage = document.createElement('div');
                    noAssignmentsMessage.classList.add('text-gray-500', 'text-center', 'py-4', 'col-span-full');
                    noAssignmentsMessage.textContent = '表示する配置先情報はありません。';
                    assignmentSummaryContainer.appendChild(noAssignmentsMessage);
                    return;
                }

                sortedAssignments.forEach(group => {
                    const card = document.createElement('div');
                    card.classList.add('assignment-card');
                    
                    let workContentHtml = `<strong>業務内容:</strong> ${group.workContent}`;
                    if (group.workContent === '日勤') {
                        workContentHtml += ` <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun inline-block text-orange-500 align-middle">
                                <circle cx="12" cy="12" r="8"/><line x1="12" x2="12" y1="2" y2="4"/><line x1="12" x2="12" y1="20" y2="22"/><line x1="4.22" x2="5.64" y1="4.22" y2="5.64"/><line x1="18.36" x2="19.78" y1="18.36" y2="19.78"/><line x1="2" x2="4" y1="12" y2="12"/><line x1="20" x2="22" y1="12" y2="12"/><line x1="4.22" x2="5.64" y1="19.78" y2="18.36"/><line x1="18.36" x2="19.78" y1="5.64" y2="4.22"/>`;
                        workContentHtml += `</svg>`;
                    } else if (group.workContent === '夜勤') {
                        workContentHtml += ` <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon inline-block text-blue-500 align-middle">
                                <path d="M12 3a6.36 6.36 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
                            </svg>`;
                    }

                    const inProgressCountClass = group.inProgressMembers.length === 0 ? 'zero-count' : '';
                    const pendingReportCountClass = group.pendingReportMembers.length === 0 ? 'zero-count' : 'text-red-600';


                    card.innerHTML = `
                        <div class="assignment-card-title">${group.assignment}</div>
                        <div class="assignment-card-detail"><strong>得意先:</strong> ${group.client}</div>
                        <div class="assignment-card-detail">${workContentHtml}</div>
                        <div class="assignment-card-detail"><strong>基本時間:</strong> ${group.baseTime}</div>
                        <div class="assignment-card-counts">
                            <div class="assignment-card-count-item" data-type="totalAssigned" data-assignment="${group.assignment}" data-members="${group.totalAssignedMembers.join(',')}">
                                <span class="assignment-card-count-label">受注</span>
                                <span class="assignment-card-count-number">${group.totalAssignedMembers.length}名</span>
                            </div>
                            <div class="assignment-card-count-item" data-type="inProgress" data-assignment="${group.assignment}" data-members="${group.inProgressMembers.join(',')}" data-status="勤務中">
                                <span class="assignment-card-count-label">勤務中</span>
                                <span class="assignment-card-count-number ${inProgressCountClass}">${group.inProgressMembers.length}名</span>
                            </div>
                            <div class="assignment-card-count-item" data-type="pendingReport" data-assignment="${group.assignment}" data-members="${group.pendingReportMembers.join(',')}" data-status="報告待ち">
                                <span class="assignment-card-count-label">報告待ち</span>
                                <span class="assignment-card-count-number ${pendingReportCountClass}">${group.pendingReportMembers.length}名</span>
                            </div>
                        </div>
                    `;
                    assignmentSummaryContainer.appendChild(card);
                });

                document.querySelectorAll('.assignment-card-count-item').forEach(item => {
                    item.addEventListener('mouseover', showTooltip);
                    item.addEventListener('mouseout', hideTooltip);
                    item.addEventListener('click', handleCountClick);
                });
            }

            function showTooltip(event, text = '') { // Added back 'text' parameter for generic use
                const members = event.currentTarget.dataset.members;
                if (members) {
                    const memberList = members.split(',').map(name => `<li>${name}</li>`).join('');
                    tooltipContent.innerHTML = `<ul>${memberList}</ul>`;
                } else {
                    tooltipContent.textContent = text; 
                }
                detailTooltip.classList.add('visible');

                const rect = event.currentTarget.getBoundingClientRect();
                detailTooltip.style.left = `${rect.left + rect.width / 2}px`;
                detailTooltip.style.top = `${rect.top + rect.height + 10}px`;
            }

            function hideTooltip() {
                detailTooltip.classList.remove('visible');
            }

            function handleCountClick(event) {
                const assignment = event.currentTarget.dataset.assignment;
                const status = event.currentTarget.dataset.status;

                currentView = 'main';
                updateScreenVisibility();

                if (status) {
                    mainSearchInput.value = ''; // Clear main search input
                    statusSearchSelect.value = status;
                } else {
                    mainSearchInput.value = ''; // Clear main search input
                    statusSearchSelect.value = '';
                }
                // Set the main search input to the assignment name to filter the table
                mainSearchInput.value = assignment;
                filterAndRenderMainTable();
            }


            function populateBranchFilterCheckboxes() {
                summaryBranchCheckboxesContainer.innerHTML = '';
                allBranches.forEach(branch => {
                    const checkboxContainer = document.createElement('label');
                    checkboxContainer.classList.add('inline-flex', 'items-center', 'cursor-pointer', 'px-3', 'py-1', 'rounded-md', 'bg-gray-100', 'hover:bg-gray-200', 'transition-colors');
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = branch;
                    checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-blue-600', 'rounded', 'mr-1');
                    checkbox.checked = selectedSummaryBranches.includes(branch);
                    checkbox.setAttribute('aria-label', `支店フィルター: ${branch}`);

                    checkbox.addEventListener('change', (event) => {
                        if (event.target.checked) {
                            if (!selectedSummaryBranches.includes(branch)) {
                                selectedSummaryBranches.push(branch);
                            }
                        } else {
                            selectedSummaryBranches = selectedSummaryBranches.filter(b => b !== branch);
                        }
                        filterAndRenderSummary();
                    });

                    checkboxContainer.appendChild(checkbox);
                    checkboxContainer.appendChild(document.createTextNode(branch));
                    summaryBranchCheckboxesContainer.appendChild(checkboxContainer);
                });
            }

            function filterAndRenderSummary() {
                let dataForSummary = [...allTableData];

                dataForSummary = dataForSummary.filter(item => item.assignmentStatus !== '未配置');

                dataForSummary = dataForSummary.filter(item => selectedSummaryBranches.includes(item.branch));

                if (showOnlyPending) {
                    dataForSummary = dataForSummary.filter(item => item.status === '報告待ち');
                }

                renderAssignmentSummary(dataForSummary);
            }

            if (screenSwitchButton) {
                screenSwitchButton.addEventListener('click', () => {
                    currentView = 'summary';
                    updateScreenVisibility();
                    selectedSummaryBranches = [...allBranches];
                    showOnlyPending = false;
                    summaryPendingFilter.classList.remove('bg-yellow-600');
                });
            }

            if (backToMainButton) {
                backToMainButton.addEventListener('click', () => {
                    currentView = 'main';
                    updateScreenVisibility();
                    assignmentSummaryContainer.innerHTML = '';
                });
            }

            if (summaryCloseButton) {
                summaryCloseButton.addEventListener('click', () => {
                    currentView = 'main';
                    updateScreenVisibility();
                    assignmentSummaryContainer.innerHTML = '';
                });
            }

            if (summaryPendingFilter) {
                summaryPendingFilter.addEventListener('click', () => {
                    showOnlyPending = !showOnlyPending;
                    if (showOnlyPending) {
                        summaryPendingFilter.classList.add('bg-yellow-600');
                    } else {
                        summaryPendingFilter.classList.remove('bg-yellow-600');
                    }
                    filterAndRenderSummary();
                });
            }

            function renderUnassignedPersonnelTable() {
                unassignedPersonnelTableBody.innerHTML = '';

                let filteredUnassignedData = unassignedPersonnelData.filter(item => {
                    const matchesBranch = selectedUnassignedBranches.includes(item.branch);
                    const searchTermLower = unassignedSearchTerm.toLowerCase();
                    const matchesSearch = item.teamMember.toLowerCase().includes(searchTermLower) ||
                                                item.consecutiveWorkStatus.toLowerCase().includes(searchTermLower) ||
                                                item.holidayStatus.toLowerCase().includes(searchTermLower);
                    return matchesBranch && matchesSearch;
                });

                if (unassignedCurrentSortKey) {
                    filteredUnassignedData = sortTableData(filteredUnassignedData, unassignedCurrentSortKey, unassignedCurrentSortDirection);
                }


                if (filteredUnassignedData.length === 0) {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="4" class="px-6 py-4 text-sm text-gray-500 text-center">未配置者はいません。</td>`;
                    unassignedPersonnelTableBody.appendChild(noDataRow);
                    return;
                }

                filteredUnassignedData.forEach(rowData => {
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-50');

                    const branchCell = document.createElement('td');
                    branchCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    branchCell.textContent = rowData.branch;
                    row.appendChild(branchCell);

                    const teamMemberCell = document.createElement('td');
                    teamMemberCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    const teamMemberDiv = document.createElement('div');
                    teamMemberDiv.classList.add('flex', 'items-center');
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = rowData.teamMember;
                    teamMemberDiv.appendChild(nameSpan);
                    
                    const phoneIconSvg = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-phone cursor-pointer text-gray-500 hover:text-gray-700 transition-colors ml-2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-3.67-3.67A19.79 19.79 0 0 1 2 5.18 2 2 0 0 1 4.11 3h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                    `;
                    const phoneIconWrapper = document.createElement('span');
                    phoneIconWrapper.innerHTML = phoneIconSvg;
                    phoneIconWrapper.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent row click from firing
                        openPhoneCallModal(rowData.teamMember, rowData.phoneNumber);
                    });
                    teamMemberDiv.appendChild(phoneIconWrapper);
                    teamMemberCell.appendChild(teamMemberDiv);
                    row.appendChild(teamMemberCell);

                    const consecutiveWorkStatusCell = document.createElement('td');
                    consecutiveWorkStatusCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    if (rowData.consecutiveWorkStatus === '6連勤中') {
                        consecutiveWorkStatusCell.classList.add('consecutive-work-red');
                    }
                    consecutiveWorkStatusCell.textContent = rowData.consecutiveWorkStatus;
                    row.appendChild(consecutiveWorkStatusCell);

                    const holidayStatusCell = document.createElement('td');
                    holidayStatusCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    holidayStatusCell.textContent = rowData.holidayStatus;
                    row.appendChild(holidayStatusCell);

                    unassignedPersonnelTableBody.appendChild(row);
                });
            }

            function filterAndRenderUnassignedPersonnelTable() {
                renderUnassignedPersonnelTable();
                updateGenericSortIndicators(document.querySelectorAll('#unassigned-personnel-screen th[data-sort-key]'), unassignedCurrentSortKey, unassignedCurrentSortDirection);
            }

            function populateUnassignedBranchFilterCheckboxes() {
                unassignedBranchCheckboxesContainer.innerHTML = '';
                allBranches.forEach(branch => {
                    const checkboxContainer = document.createElement('label');
                    checkboxContainer.classList.add('inline-flex', 'items-center', 'cursor-pointer', 'px-3', 'py-1', 'rounded-md', 'bg-gray-100', 'hover:bg-gray-200', 'transition-colors');
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = branch;
                    checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-blue-600', 'rounded', 'mr-1');
                    checkbox.checked = selectedUnassignedBranches.includes(branch);
                    checkbox.setAttribute('aria-label', `未配置者支店フィルター: ${branch}`);

                    checkbox.addEventListener('change', (event) => {
                        if (event.target.checked) {
                            if (!selectedUnassignedBranches.includes(branch)) {
                                selectedUnassignedBranches.push(branch);
                            }
                        } else {
                            selectedUnassignedBranches = selectedUnassignedBranches.filter(b => b !== branch);
                        }
                        filterAndRenderUnassignedPersonnelTable();
                    });

                    checkboxContainer.appendChild(checkbox);
                    checkboxContainer.appendChild(document.createTextNode(branch));
                    unassignedBranchCheckboxesContainer.appendChild(checkboxContainer);
                });
            }

            document.querySelectorAll('#unassigned-personnel-screen th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sortKey;
                    if (sortKey) {
                        if (unassignedCurrentSortKey === sortKey) {
                            unassignedCurrentSortDirection = unassignedCurrentSortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            unassignedCurrentSortKey = sortKey;
                            unassignedCurrentSortDirection = 'asc';
                        }
                        filterAndRenderUnassignedPersonnelTable();
                    }
                });
            });


            if (unassignedPersonnelButton) {
                unassignedPersonnelButton.addEventListener('click', () => {
                    currentView = 'unassigned';
                    updateScreenVisibility();
                });
            }

            if (unassignedCloseButton) {
                unassignedCloseButton.addEventListener('click', () => {
                    currentView = 'main';
                    updateScreenVisibility();
                });
            }

            if (unassignedBackToMainButton) {
                unassignedBackToMainButton.addEventListener('click', () => {
                    currentView = 'main';
                    updateScreenVisibility();
                });
            }

            if (unassignedSearchInput) {
                unassignedSearchInput.addEventListener('input', (event) => {
                    unassignedSearchTerm = event.target.value.trim();
                    filterAndRenderUnassignedPersonnelTable();
                });
            }

            function renderWorkHistoryTable() {
                workHistoryTableBody.innerHTML = '';
                workHistoryTitle.textContent = `勤務履歴確認画面: ${currentWorkHistoryAssignment}`;

                let dataForWorkHistory = allTableData.filter(item => item.assignment === currentWorkHistoryAssignment);

                const searchTermLower = workHistorySearchTerm.toLowerCase();
                dataForWorkHistory = dataForWorkHistory.filter(item => {
                    return item.teamMember.toLowerCase().includes(searchTermLower) ||
                           item.branch.toLowerCase().includes(searchTermLower) ||
                           item.consecutiveWorkStatus.toLowerCase().includes(searchTermLower) ||
                           item.holidayStatus.toLowerCase().includes(searchTermLower) ||
                           item.assignmentStatus.toLowerCase().includes(searchTermLower) ||
                           item.lastWorkDate.toLowerCase().includes(searchTermLower);
                });

                dataForWorkHistory = dataForWorkHistory.filter(item => selectedWorkHistoryBranches.includes(item.branch));

                if (showOnlyUnassignedInWorkHistory) {
                    dataForWorkHistory = dataForWorkHistory.filter(item => item.assignmentStatus === '未配置');
                }

                if (workHistoryCurrentSortKey) {
                    dataForWorkHistory = sortTableData(dataForWorkHistory, workHistoryCurrentSortKey, workHistoryCurrentSortDirection);
                }

                if (dataForWorkHistory.length === 0) {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="6" class="px-6 py-4 text-sm text-gray-500 text-center">この配置先の勤務履歴はありません。</td>`;
                    workHistoryTableBody.appendChild(noDataRow);
                    return;
                }

                dataForWorkHistory.forEach(rowData => {
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-50');

                    const branchCell = document.createElement('td');
                    branchCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    branchCell.textContent = rowData.branch;
                    row.appendChild(branchCell);

                    const teamMemberCell = document.createElement('td');
                    teamMemberCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    const teamMemberDiv = document.createElement('div');
                    teamMemberDiv.classList.add('flex', 'items-center');
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = rowData.teamMember;
                    teamMemberDiv.appendChild(nameSpan);
                    
                    const phoneIconSvg = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="0" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-phone cursor-pointer text-gray-500 hover:text-gray-700 transition-colors ml-2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-3.67-3.67A19.79 19.79 0 0 1 2 5.18 2 2 0 0 1 4.11 3h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                    `;
                    const phoneIconWrapper = document.createElement('span');
                    phoneIconWrapper.innerHTML = phoneIconSvg;
                    phoneIconWrapper.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent row click from firing
                        openPhoneCallModal(rowData.teamMember, rowData.phoneNumber);
                    });
                    teamMemberDiv.appendChild(phoneIconWrapper);
                    teamMemberCell.appendChild(teamMemberDiv);
                    row.appendChild(teamMemberCell);

                    const consecutiveWorkStatusCell = document.createElement('td');
                    consecutiveWorkStatusCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    if (rowData.consecutiveWorkStatus === '6連勤中') {
                        consecutiveWorkStatusCell.classList.add('consecutive-work-red');
                    }
                    consecutiveWorkStatusCell.textContent = rowData.consecutiveWorkStatus;
                    row.appendChild(consecutiveWorkStatusCell);

                    const holidayStatusCell = document.createElement('td');
                    holidayStatusCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    holidayStatusCell.textContent = rowData.holidayStatus;
                    row.appendChild(holidayStatusCell);

                    const assignmentStatusCell = document.createElement('td');
                    assignmentStatusCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    assignmentStatusCell.textContent = rowData.assignmentStatus;
                    row.appendChild(assignmentStatusCell);

                    const lastWorkDateCell = document.createElement('td');
                    lastWorkDateCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    lastWorkDateCell.textContent = rowData.lastWorkDate;
                    row.appendChild(lastWorkDateCell);

                    workHistoryTableBody.appendChild(row);
                });
            }

            function filterAndRenderWorkHistoryTable() {
                renderWorkHistoryTable();
                updateGenericSortIndicators(document.querySelectorAll('#work-history-screen th[data-sort-key]'), workHistoryCurrentSortKey, workHistoryCurrentSortDirection);
            }

            function populateWorkHistoryBranchFilterCheckboxes() {
                workHistoryBranchCheckboxesContainer.innerHTML = '';
                allBranches.forEach(branch => {
                    const checkboxContainer = document.createElement('label');
                    checkboxContainer.classList.add('inline-flex', 'items-center', 'cursor-pointer', 'px-3', 'py-1', 'rounded-md', 'bg-gray-100', 'hover:bg-gray-200', 'transition-colors');
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = branch;
                    checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-blue-600', 'rounded', 'mr-1');
                    checkbox.checked = selectedWorkHistoryBranches.includes(branch);
                    checkbox.setAttribute('aria-label', `勤務履歴支店フィルター: ${branch}`);

                    checkbox.addEventListener('change', (event) => {
                        if (event.target.checked) {
                            if (!selectedWorkHistoryBranches.includes(branch)) {
                                selectedWorkHistoryBranches.push(branch);
                            }
                        } else {
                            selectedWorkHistoryBranches = selectedWorkHistoryBranches.filter(b => b !== branch);
                        }
                        filterAndRenderWorkHistoryTable();
                    });

                    checkboxContainer.appendChild(checkbox);
                    checkboxContainer.appendChild(document.createTextNode(branch));
                    workHistoryBranchCheckboxesContainer.appendChild(checkboxContainer);
                });
            }

            document.querySelectorAll('#work-history-screen th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sortKey;
                    if (sortKey) {
                        if (workHistoryCurrentSortKey === sortKey) {
                            workHistoryCurrentSortDirection = workHistoryCurrentSortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            workHistoryCurrentSortKey = sortKey;
                            workHistoryCurrentSortDirection = 'asc';
                        }
                        filterAndRenderWorkHistoryTable();
                    }
                });
            });

            if (workHistoryCloseButton) {
                workHistoryCloseButton.addEventListener('click', () => {
                    currentView = 'main';
                    updateScreenVisibility();
                });
            }

            if (workHistoryBackToMainButton) {
                workHistoryBackToMainButton.addEventListener('click', () => {
                    currentView = 'main';
                    updateScreenVisibility();
                });
            }

            if (workHistorySearchInput) {
                workHistorySearchInput.addEventListener('input', (event) => {
                    workHistorySearchTerm = event.target.value.trim();
                    filterAndRenderWorkHistoryTable();
                });
            }

            if (workHistoryUnassignedFilterButton) {
                workHistoryUnassignedFilterButton.addEventListener('click', () => {
                    showOnlyUnassignedInWorkHistory = !showOnlyUnassignedInWorkHistory;
                    if (showOnlyUnassignedInWorkHistory) {
                        workHistoryUnassignedFilterButton.classList.add('bg-yellow-600');
                    } else {
                        workHistoryUnassignedFilterButton.classList.remove('bg-yellow-600');
                    }
                    filterAndRenderWorkHistoryTable();
                });
            }


            if (unassignedPersonnelButton) {
                unassignedPersonnelButton.addEventListener('click', () => {
                    currentView = 'unassigned';
                    updateScreenVisibility();
                });
            }

            if (unassignedCloseButton) {
                unassignedCloseButton.addEventListener('click', () => {
                    currentView = 'main';
                    updateScreenVisibility();
                });
            }

            if (unassignedBackToMainButton) {
                unassignedBackToMainButton.addEventListener('click', () => {
                    currentView = 'main';
                    updateScreenVisibility();
                });
            }

            if (unassignedSearchInput) {
                unassignedSearchInput.addEventListener('input', (event) => {
                    unassignedSearchTerm = event.target.value.trim();
                    filterAndRenderUnassignedPersonnelTable();
                });
            }

            // --- Assignment Detail Modal Functions ---
            function openAssignmentDetailModal(rowData) {
                assignmentDetailModalTitle.textContent = `${rowData.assignment} 詳細`;
                
                // Set up Work History link
                assignmentDetailWorkHistory.querySelector('.assignment-detail-value').textContent = '確認する';
                assignmentDetailWorkHistory.onclick = () => {
                    currentWorkHistoryAssignment = rowData.assignment;
                    currentView = 'work-history';
                    updateScreenVisibility();
                    closeAssignmentDetailModal();
                };
                // Updated tooltip text for "電話番号"
                assignmentDetailWorkHistory.addEventListener('mouseover', (event) => showTooltip(event, '勤務履歴を確認'));
                assignmentDetailWorkHistory.addEventListener('mouseout', hideTooltip);

                // Set up Phone Number link
                assignmentDetailPhoneNumber.querySelector('.assignment-detail-value').textContent = rowData.phoneNumber;
                assignmentDetailPhoneNumber.onclick = () => {
                    openPhoneCallModal(rowData.teamMember, rowData.phoneNumber);
                    closeAssignmentDetailModal();
                };
                // Updated tooltip text for "電話番号"
                assignmentDetailPhoneNumber.addEventListener('mouseover', (event) => showTooltip(event, '電話をかける'));
                assignmentDetailPhoneNumber.addEventListener('mouseout', hideTooltip);

                // Set up Site Address link
                assignmentDetailSiteAddress.querySelector('.assignment-detail-value').textContent = rowData.siteAddress;
                assignmentDetailSiteAddress.onclick = () => {
                    if (rowData.siteAddress && rowData.siteAddress !== '未定') {
                        window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(rowData.siteAddress)}`, '_blank');
                    } else {
                        console.log('現場住所が未定のため、地図を開けません。');
                    }
                    closeAssignmentDetailModal();
                };
                // Updated tooltip text for "現場住所"
                assignmentDetailSiteAddress.addEventListener('mouseover', (event) => showTooltip(event, 'GoogleMapで確認'));
                assignmentDetailSiteAddress.addEventListener('mouseout', hideTooltip);

                // New: Set up Site Supervisor Name
                assignmentDetailSiteSupervisor.querySelector('.assignment-detail-value').textContent = rowData.siteSupervisor;
                // No click or mouseover actions for site supervisor as per request

                assignmentDetailModal.classList.add('open');
            }

            function closeAssignmentDetailModal() {
                assignmentDetailModal.classList.remove('open');
            }

            if (assignmentDetailModalCloseButton) {
                assignmentDetailModalCloseButton.addEventListener('click', closeAssignmentDetailModal);
            }

            if (assignmentDetailOkButton) {
                assignmentDetailOkButton.addEventListener('click', closeAssignmentDetailModal);
            }

            if (assignmentDetailModal) {
                assignmentDetailModal.addEventListener('click', (event) => {
                    if (event.target === assignmentDetailModal) {
                        closeAssignmentDetailModal();
                    }
                });
            }
            // --- End Assignment Detail Modal Functions ---


            updateScreenVisibility();
        });
    </script>
</body>
</html>
